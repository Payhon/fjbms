# OrgTree 多层级组织改造 - 回归测试清单

## 测试环境准备

### 数据库
- [ ] 执行 `backend/sql/20.sql` 迁移脚本
- [ ] 确认 `orgs`, `org_closure`, `device_org_transfers` 表已创建
- [ ] 确认 `users` 表已添加 `org_id`, `user_kind` 字段
- [ ] 确认 `device_batteries` 表已添加 `owner_org_id`, `bms_factory_org_id`, `pack_factory_org_id` 字段

### 初始化测试数据
- [ ] 创建测试租户
- [ ] 创建 BMS 厂家组织（顶级，org_type=BMS_FACTORY）
- [ ] 创建 PACK 厂家组织（parent_id=BMS厂家，org_type=PACK_FACTORY）
- [ ] 创建经销商组织（parent_id=PACK厂家，org_type=DEALER）
- [ ] 创建门店组织（parent_id=经销商，org_type=STORE）

---

## 一、组织树管理

### 1.1 组织 CRUD

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T01 | 创建 BMS_FACTORY 组织 | 成功创建，org_closure 自动写入自环记录（depth=0） | [ ] |
| T02 | 创建 PACK_FACTORY 组织（指定 parent_id=BMS厂家） | 成功创建，org_closure 包含：自环 + 到 BMS 厂家的关系 | [ ] |
| T03 | 创建 DEALER 组织（指定 parent_id=PACK厂家） | 成功创建，org_closure 包含完整祖先链 | [ ] |
| T04 | 创建 STORE 组织（指定 parent_id=DEALER） | 成功创建，闭包表完整 | [ ] |
| T05 | 更新组织信息（名称/联系人等） | 更新成功，不影响闭包表 | [ ] |
| T06 | 删除有子组织的组织 | 拒绝删除，提示"存在子组织" | [ ] |
| T07 | 删除有关联设备的组织 | 拒绝删除，提示"存在关联设备" | [ ] |
| T08 | 删除叶子组织（无子组织、无设备） | 成功删除，同时删除闭包表相关记录 | [ ] |

### 1.2 组织树查询

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T09 | 获取全量组织树 | 返回树结构，包含所有层级 | [ ] |
| T10 | 按 org_type=PACK_FACTORY 筛选 | 仅返回 PACK 厂家组织 | [ ] |
| T11 | 按 org_type=DEALER 筛选 | 仅返回经销商组织 | [ ] |
| T12 | 按 org_type=STORE 筛选 | 仅返回门店组织 | [ ] |
| T13 | 组织列表分页查询 | 正确分页，支持 name/status 筛选 | [ ] |

---

## 二、设备流转链路

### 2.1 设备分配（BMS -> PACK -> DEALER -> STORE）

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T20 | BMS 厂家分配设备给 PACK 厂家 | device_batteries.owner_org_id 更新，device_org_transfers 记录写入 | [ ] |
| T21 | PACK 厂家转移设备给经销商 | owner_org_id 更新，转移记录包含 from/to 组织信息 | [ ] |
| T22 | 经销商转移设备给门店 | 同上 | [ ] |
| T23 | 门店售出（终端用户绑定） | transfer_status=USER，device_user_bindings 记录创建 | [ ] |
| T24 | 设备退回（从门店到经销商） | owner_org_id 更新为经销商，转移记录包含逆向信息 | [ ] |

### 2.2 转移记录查询

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T25 | 查询设备转移历史 | 返回完整转移链，包含组织名称和类型 | [ ] |
| T26 | 按设备编号筛选转移记录 | 正确返回该设备的转移历史 | [ ] |
| T27 | 按时间范围筛选 | 正确返回时间范围内的记录 | [ ] |

---

## 三、权限隔离

### 3.1 设备数据隔离

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T30 | BMS 厂家账号查看设备列表 | 看到所有租户设备 | [ ] |
| T31 | PACK 厂家账号查看设备列表 | 仅看到名下（子树）设备 | [ ] |
| T32 | 经销商账号查看设备列表 | 仅看到名下（子树）设备 | [ ] |
| T33 | 门店账号查看设备列表 | 仅看到门店名下设备 | [ ] |
| T34 | PACK 厂家查看非子树设备详情 | 拒绝访问 | [ ] |
| T35 | 经销商操作非子树设备（参数修改） | 拒绝操作 | [ ] |

### 3.2 统计隔离

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T36 | BMS 厂家 Dashboard KPI | 显示全量统计 | [ ] |
| T37 | PACK 厂家 Dashboard KPI | 显示子树统计 | [ ] |
| T38 | 经销商 Dashboard KPI | 显示子树统计 | [ ] |
| T39 | 告警概览按组织过滤 | 正确统计子树内告警 | [ ] |

---

## 四、终端用户场景

### 4.1 设备绑定

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T40 | 终端用户扫码绑定设备（门店名下） | 绑定成功，transfer_status=USER | [ ] |
| T41 | 终端用户绑定非组织子树设备 | 允许（终端用户不受组织限制） | [ ] |
| T42 | 终端用户解绑设备 | 解绑成功，若无其他绑定则 transfer_status 回退 | [ ] |

### 4.2 终端用户管理

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T43 | BMS 厂家查看终端用户列表 | 看到所有用户 | [ ] |
| T44 | 经销商查看终端用户列表 | 仅看到子树设备关联的用户 | [ ] |
| T45 | 强制解绑（组织权限内） | 解绑成功 | [ ] |
| T46 | 强制解绑（组织权限外） | 拒绝操作 | [ ] |

---

## 五、离线指令

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T50 | PACK 厂家查看离线指令列表 | 仅看到子树设备的指令 | [ ] |
| T51 | 经销商取消离线指令（权限内） | 取消成功 | [ ] |
| T52 | 经销商取消离线指令（权限外） | 拒绝操作 | [ ] |

---

## 六、前端界面

### 6.1 组织管理页面

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T60 | 直接访问 /bms/org/management | 显示 TAB（PACK厂家/经销商/门店） | [ ] |
| T61 | 通过快捷方式访问（带 org_type 参数） | 隐藏 TAB，固定显示对应类型 | [ ] |
| T62 | PACK厂家管理快捷入口 | 跳转并显示 PACK_FACTORY 列表 | [ ] |
| T63 | 经销商管理快捷入口 | 跳转并显示 DEALER 列表 | [ ] |
| T64 | 门店管理快捷入口 | 跳转并显示 STORE 列表 | [ ] |

### 6.2 设备分配/转移

| 用例 | 操作 | 预期结果 | 验证状态 |
|------|------|----------|----------|
| T65 | 设备分配目标选择 | 显示组织树选择器（非经销商下拉） | [ ] |
| T66 | 组织树选择器筛选 | 支持按 PACK/DEALER/STORE 筛选 | [ ] |

---

## 验收标准

- [ ] 所有 T0x 用例通过
- [ ] 所有 T2x 用例通过
- [ ] 所有 T3x 用例通过
- [ ] 所有 T4x 用例通过
- [ ] 所有 T5x 用例通过
- [ ] 所有 T6x 用例通过
- [ ] 无生产级别 Bug
- [ ] 性能可接受（闭包表子查询响应 < 200ms）

---

## 备注

- 闭包表查询性能：若组织层级超过 5 级且节点数超过 1000，需关注 org_closure 查询性能
- 数据迁移：系统未上线，无需迁移历史数据
- 兼容性：原 dealer_id 字段保留，旧 API 暂不删除
