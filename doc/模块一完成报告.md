# æ¨¡å—ä¸€ï¼šè®¾å¤‡è½¬ç§»åŠŸèƒ½ - å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2025-12-02 08:45  
**æ¨¡å—çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“¦ äº¤ä»˜å†…å®¹

### 1. Service å±‚ (3ä¸ªæ–‡ä»¶)

#### âœ… `/backend/internal/service/dealer.go`
ç»é”€å•†ç®¡ç†æœåŠ¡ï¼ŒåŒ…å«ï¼š
- `CreateDealer` - åˆ›å»ºç»é”€å•†
- `UpdateDealer` - æ›´æ–°ç»é”€å•†
- `DeleteDealer` - åˆ é™¤ç»é”€å•†ï¼ˆå«ä¸šåŠ¡æ ¡éªŒï¼‰
- `GetDealerByID` - è·å–è¯¦æƒ…
- `GetDealerList` - åˆ†é¡µåˆ—è¡¨

#### âœ… `/backend/internal/service/battery_model.go`
ç”µæ± å‹å·ç®¡ç†æœåŠ¡ï¼ŒåŒ…å«ï¼š
- `CreateBatteryModel` - åˆ›å»ºå‹å·
- `UpdateBatteryModel` - æ›´æ–°å‹å·
- `DeleteBatteryModel` - åˆ é™¤å‹å·ï¼ˆå«ä¸šåŠ¡æ ¡éªŒï¼‰
- `GetBatteryModelByID` - è·å–è¯¦æƒ…
- `GetBatteryModelList` - åˆ†é¡µåˆ—è¡¨

#### âœ… `/backend/internal/service/device_transfer.go`
è®¾å¤‡è½¬ç§»æœåŠ¡ï¼ŒåŒ…å«ï¼š
- `TransferDevices` - æ‰¹é‡è½¬ç§»è®¾å¤‡ï¼ˆå«äº‹åŠ¡å¤„ç†ï¼‰
- `GetTransferHistory` - è½¬ç§»è®°å½•æŸ¥è¯¢ï¼ˆå«å…³è”æŸ¥è¯¢ï¼‰

**æŠ€æœ¯äº®ç‚¹**:
- å®Œæ•´çš„äº‹åŠ¡å¤„ç†æœºåˆ¶
- ä¸šåŠ¡æ ¡éªŒï¼ˆåˆ é™¤å‰æ£€æŸ¥å…³è”æ•°æ®ï¼‰
- æ•°æ®æƒé™æ§åˆ¶ï¼ˆtenant_id æ ¡éªŒï¼‰
- å…³è”æŸ¥è¯¢ä¼˜åŒ–

---

### 2. API å±‚ (3ä¸ªæ–‡ä»¶)

#### âœ… `/backend/internal/api/dealer.go`
ç»é”€å•†ç®¡ç† APIï¼Œè·¯ç”±ï¼š
- `POST /api/v1/dealer` - åˆ›å»º
- `PUT /api/v1/dealer/:id` - æ›´æ–°
- `DELETE /api/v1/dealer/:id` - åˆ é™¤
- `GET /api/v1/dealer/:id` - è¯¦æƒ…
- `GET /api/v1/dealer` - åˆ—è¡¨

#### âœ… `/backend/internal/api/battery_model.go`
ç”µæ± å‹å·ç®¡ç† APIï¼Œè·¯ç”±ï¼š
- `POST /api/v1/battery/model` - åˆ›å»º
- `PUT /api/v1/battery/model/:id` - æ›´æ–°
- `DELETE /api/v1/battery/model/:id` - åˆ é™¤
- `GET /api/v1/battery/model/:id` - è¯¦æƒ…
- `GET /api/v1/battery/model` - åˆ—è¡¨

#### âœ… `/backend/internal/api/device_transfer.go`
è®¾å¤‡è½¬ç§» APIï¼Œè·¯ç”±ï¼š
- `POST /api/v1/device/transfer` - æ‰¹é‡è½¬ç§»
- `GET /api/v1/device/transfer/history` - è½¬ç§»è®°å½•

**æŠ€æœ¯äº®ç‚¹**:
- Swagger æ–‡æ¡£æ³¨é‡Šå®Œæ•´
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- è¯·æ±‚å‚æ•°éªŒè¯

---

### 3. è·¯ç”±æ³¨å†Œ (3ä¸ªæ–‡ä»¶)

#### âœ… `/backend/router/apps/dealer.go`
ç»é”€å•†è·¯ç”±é…ç½®

#### âœ… `/backend/router/apps/battery_model.go`
ç”µæ± å‹å·è·¯ç”±é…ç½®

#### âœ… `/backend/router/apps/device_transfer.go`
è®¾å¤‡è½¬ç§»è·¯ç”±é…ç½®

#### âœ… æ›´æ–°çš„æ–‡ä»¶
- `/backend/router/apps/enter.go` - æ·»åŠ è·¯ç”±æ¨¡å—æ³¨å†Œ
- `/backend/router/router_init.go` - æ·»åŠ è·¯ç”±åˆå§‹åŒ–è°ƒç”¨
- `/backend/internal/api/enter.go` - æ·»åŠ  API æ§åˆ¶å™¨æ³¨å†Œ
- `/backend/internal/service/enter.go` - æ·»åŠ æœåŠ¡æ³¨å†Œ

---

## ğŸ¯ åŠŸèƒ½éªŒè¯æ¸…å•

### ç»é”€å•†ç®¡ç†
- [ ] åˆ›å»ºç»é”€å•†
- [ ] æ›´æ–°ç»é”€å•†ä¿¡æ¯
- [ ] åˆ é™¤ç»é”€å•†ï¼ˆéœ€éªŒè¯æ— ä¸‹çº§å’Œè®¾å¤‡ï¼‰
- [ ] æŸ¥è¯¢ç»é”€å•†è¯¦æƒ…ï¼ˆå«è®¾å¤‡ç»Ÿè®¡ï¼‰
- [ ] åˆ†é¡µæŸ¥è¯¢ç»é”€å•†åˆ—è¡¨

### ç”µæ± å‹å·ç®¡ç†
- [ ] åˆ›å»ºç”µæ± å‹å·
- [ ] æ›´æ–°å‹å·ä¿¡æ¯
- [ ] åˆ é™¤å‹å·ï¼ˆéœ€éªŒè¯æ— å…³è”è®¾å¤‡ï¼‰
- [ ] æŸ¥è¯¢å‹å·è¯¦æƒ…ï¼ˆå«è®¾å¤‡ç»Ÿè®¡ï¼‰
- [ ] åˆ†é¡µæŸ¥è¯¢å‹å·åˆ—è¡¨

### è®¾å¤‡è½¬ç§»
- [ ] æ‰¹é‡è½¬ç§»è®¾å¤‡åˆ°ç»é”€å•†
- [ ] æ‰¹é‡è½¬ç§»è®¾å¤‡å›å‚å®¶
- [ ] æŸ¥è¯¢è½¬ç§»å†å²è®°å½•
- [ ] è½¬ç§»è®°å½•å…³è”æŸ¥è¯¢ï¼ˆè®¾å¤‡ã€ç»é”€å•†ã€æ“ä½œäººï¼‰

---

## ğŸ“Š API æ¥å£æ¸…å•

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | æƒé™ |
|---------|------|------|------|
| /api/v1/dealer | POST | åˆ›å»ºç»é”€å•† | éœ€è®¤è¯ |
| /api/v1/dealer/:id | PUT | æ›´æ–°ç»é”€å•† | éœ€è®¤è¯ |
| /api/v1/dealer/:id | DELETE | åˆ é™¤ç»é”€å•† | éœ€è®¤è¯ |
| /api/v1/dealer/:id | GET | ç»é”€å•†è¯¦æƒ… | éœ€è®¤è¯ |
| /api/v1/dealer | GET | ç»é”€å•†åˆ—è¡¨ | éœ€è®¤è¯ |
| /api/v1/battery/model | POST | åˆ›å»ºå‹å· | éœ€è®¤è¯ |
| /api/v1/battery/model/:id | PUT | æ›´æ–°å‹å· | éœ€è®¤è¯ |
| /api/v1/battery/model/:id | DELETE | åˆ é™¤å‹å· | éœ€è®¤è¯ |
| /api/v1/battery/model/:id | GET | å‹å·è¯¦æƒ… | éœ€è®¤è¯ |
| /api/v1/battery/model | GET | å‹å·åˆ—è¡¨ | éœ€è®¤è¯ |
| /api/v1/device/transfer | POST | æ‰¹é‡è½¬ç§» | éœ€è®¤è¯ |
| /api/v1/device/transfer/history | GET | è½¬ç§»è®°å½• | éœ€è®¤è¯ |

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. äº‹åŠ¡å¤„ç†
```go
tx := query.Use(global.DB).Begin()
defer func() {
    if r := recover(); r != nil {
        tx.Rollback()
    }
}()

// ä¸šåŠ¡æ“ä½œ...

if err := tx.Commit(); err != nil {
    return err
}
```

### 2. ä¸šåŠ¡æ ¡éªŒ
```go
// åˆ é™¤å‰æ£€æŸ¥å…³è”æ•°æ®
deviceCount, _ := query.DeviceBattery.Where(
    query.DeviceBattery.DealerID.Eq(id)
).Count()

if deviceCount > 0 {
    return errcode.WithData(errcode.CodeParamError, map[string]interface{}{
        "message": "dealer has devices, please transfer them first",
    })
}
```

### 3. å…³è”æŸ¥è¯¢
```go
// æŸ¥è¯¢è®¾å¤‡ä¿¡æ¯
device, err := d.WithContext(ctx).Where(d.ID.Eq(transfer.DeviceID)).First()

// æŸ¥è¯¢ç»é”€å•†åç§°
dealer, err := dealer.WithContext(ctx).Where(dealer.ID.Eq(*transfer.FromDealerID)).First()
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç¼–è¯‘å‰å‡†å¤‡
1. éœ€è¦è¿è¡Œ GORM Gen ç”Ÿæˆ query ä»£ç ï¼š
   ```bash
   cd backend
   go run cmd/gen/main.go
   ```

2. ç¡®ä¿å¯¼å…¥è·¯å¾„æ­£ç¡®ï¼š
   ```go
   import (
       "project/internal/model"
       "project/internal/query"
       "project/internal/service"
   )
   ```

### æ•°æ®åº“å‡†å¤‡
1. æ‰§è¡Œè¿ç§»è„šæœ¬ï¼š
   ```bash
   psql -U postgres -d ThingsPanel -f backend/sql/13.sql
   ```

2. éªŒè¯è¡¨åˆ›å»ºï¼š
   ```sql
   \dt dealers
   \dt battery_models
   \dt device_batteries
   \dt device_transfers
   ```

---

## ğŸ“ ä¸‹ä¸€æ­¥è®¡åˆ’

### æ¨¡å—äºŒï¼šè®¾å¤‡ç»‘å®šåŠŸèƒ½
- [ ] Service: è®¾å¤‡ç»‘å®šæœåŠ¡
- [ ] API: APP ç«¯è®¾å¤‡ç»‘å®šæ¥å£
- [ ] åŠŸèƒ½: æ‰«ç ç»‘å®šã€è§£ç»‘ã€ç”¨æˆ·è®¾å¤‡åˆ—è¡¨

### æ¨¡å—ä¸‰ï¼šç»´ä¿ç®¡ç†åŠŸèƒ½
- [ ] Service: ç»´ä¿ç”³è¯·æœåŠ¡
- [ ] API: ç»´ä¿ç®¡ç†æ¥å£
- [ ] åŠŸèƒ½: ç”³è¯·æäº¤ã€å®¡æ‰¹ã€è®°å½•æŸ¥è¯¢

---

**æ¨¡å—ä¸€çŠ¶æ€**: âœ… å®Œæˆ  
**ä»£ç æ–‡ä»¶**: 13ä¸ª  
**API æ¥å£**: 12ä¸ª  
**ä¸‹ä¸€æ¨¡å—**: è®¾å¤‡ç»‘å®šåŠŸèƒ½
