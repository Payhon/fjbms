# ThingsPanel 数据库结构文档

## 1. 数据库概述

### 1.1 数据库类型

**主数据库**: PostgreSQL 12+  
**时序数据扩展**: TimescaleDB  
**缓存数据库**: Redis 6.0+

### 1.2 数据库设计原则

- 多租户数据隔离（通过tenant_id字段）
- 外键约束确保数据完整性
- 时序数据使用TimescaleDB超表优化
- 关键字段建立索引提升查询性能

### 1.3 数据库初始化

SQL脚本位于 `backend/sql/` 目录：
- `1.sql` - 基础表结构
- `2.sql - 12.sql` - 增量更新脚本

## 2. 核心数据表

### 2.1 用户与权限

#### 2.1.1 users (用户表)

用户基本信息表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | 用户ID | PK |
| name | varchar(255) | 用户名称 | |
| phone_number | varchar(50) | 手机号 | NOT NULL |
| email | varchar(255) | 邮箱 | NOT NULL, UNIQUE |
| status | varchar(2) | 用户状态 | F-冻结 N-正常 |
| authority | varchar(50) | 权限类型 | SYS_ADMIN / TENANT_ADMIN / TENANT_USER |
| password | varchar(255) | 密码（加密） | NOT NULL |
| tenant_id | varchar(36) | 租户ID | |
| additional_info | json | 附加信息 | DEFAULT '{}' |
| created_at | timestamptz | 创建时间 | |
| updated_at | timestamptz | 更新时间 | |
| remark | varchar(255) | 备注 | |

**索引**:
- PRIMARY KEY (id)
- UNIQUE (email)

#### 2.1.2 roles (角色表)

角色定义表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | 角色ID | PK |
| name | varchar(99) | 角色名称 | NOT NULL |
| description | varchar(255) | 描述 | |
| tenant_id | varchar(36) | 租户ID | |
| created_at | timestamp | 创建时间 | |
| updated_at | timestamp | 更新时间 | |

#### 2.1.3 casbin_rule (权限规则表)

Casbin权限控制规则表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| p_type | varchar | 策略类型 |
| v0-v5 | varchar | 策略参数 |

#### 2.1.4 sys_ui_elements (UI元素表)

系统UI元素与权限关联表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | 元素ID | PK |
| parent_id | varchar(36) | 父元素ID | NOT NULL |
| element_code | varchar(100) | 元素标识符 | NOT NULL |
| element_type | int2 | 元素类型 | 1-菜单 2-目录 3-按钮 4-路由 |
| orders | int2 | 排序 | |
| authority | json | 权限 | [1,2] 1-系统管理员 2-租户 |
| multilingual | varchar(100) | 多语言标识符 | |
| route_path | varchar(255) | 路由路径 | |
| description | varchar(255) | 描述 | |
| created_at | timestamptz | 创建时间 | |
| remark | varchar(255) | 备注 | |

### 2.2 设备管理

#### 2.2.1 devices (设备表)

设备基本信息表（核心表）

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | 设备ID | PK |
| name | varchar(255) | 设备名称 | |
| device_number | varchar(36) | 设备编号 | NOT NULL, UNIQUE |
| voucher | varchar(500) | 凭证 | NOT NULL, UNIQUE |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| product_id | varchar(36) | 产品ID | FK → products(id) |
| device_config_id | varchar(36) | 设备配置ID | FK → device_configs(id) |
| parent_id | varchar(36) | 网关ID（子设备） | |
| is_enabled | varchar(36) | 启用状态 | enabled/disabled |
| activate_flag | varchar(36) | 激活状态 | active/inactive |
| is_online | int2 | 在线状态 | 1-在线 0-离线 |
| protocol | varchar(36) | 通讯协议 | |
| access_way | varchar(10) | 接入方式 | A-协议 B-服务 |
| label | varchar(255) | 标签 | |
| location | varchar(100) | 地理位置 | |
| sub_device_addr | varchar(36) | 子设备地址 | |
| current_version | varchar(36) | 当前固件版本 | |
| batch_number | varchar(500) | 批次编号 | |
| protocol_config | json | 协议配置 | DEFAULT '{}' |
| additional_info | json | 附加信息 | DEFAULT '{}' |
| description | varchar(500) | 描述 | |
| created_at | timestamptz | 创建时间 | |
| update_at | timestamptz | 更新时间 | |
| activate_at | timestamptz | 激活时间 | |
| remark1-3 | varchar(255) | 备注字段 | |

**索引**:
- PRIMARY KEY (id)
- UNIQUE (device_number)
- UNIQUE (voucher)

**外键**: 
- device_config_id → device_configs(id) ON DELETE RESTRICT
- product_id → products(id) ON DELETE RESTRICT

#### 2.2.2 device_configs (设备配置表)

设备配置模板表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | 配置ID | PK |
| name | varchar(99) | 配置名称 | NOT NULL |
| device_template_id | varchar(36) | 设备模板ID | FK → device_templates(id) |
| device_type | varchar(9) | 设备类型 | 1-直连 2-网关 3-子设备 |
| protocol_type | varchar(36) | 协议类型 | |
| voucher_type | varchar(36) | 凭证类型 | |
| device_conn_type | varchar(36) | 连接方式 | A-设备连平台 B-平台连设备 |
| protocol_config | json | 协议配置 | |
| other_config | json | 其他配置 | |
| additional_info | json | 附加信息 | DEFAULT '{}' |
| description | varchar(255) | 描述 | |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

**外键**:
- device_template_id → device_templates(id) ON DELETE RESTRICT

#### 2.2.3 device_templates (设备模板表)

设备功能模板表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | 模板ID | PK |
| name | varchar(255) | 模板名称 | NOT NULL |
| author | varchar(36) | 作者 | |
| version | varchar(50) | 版本号 | |
| label | varchar(255) | 标签 | |
| path | varchar(999) | 图片路径 | |
| web_chart_config | json | Web图表配置 | |
| app_chart_config | json | App图表配置 | |
| description | varchar(500) | 描述 | |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| flag | int2 | 标志 | DEFAULT 1 |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.2.4 device_model_telemetry (设备遥测模型)

设备遥测数据模型定义

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| device_template_id | varchar(36) | 设备模板ID | FK, NOT NULL |
| data_name | varchar(255) | 数据名称 | |
| data_identifier | varchar(255) | 数据标识符 | NOT NULL |
| read_write_flag | varchar(10) | 读写标志 | R/W/RW |
| data_type | varchar(50) | 数据类型 | String/Number/Boolean |
| unit | varchar(50) | 单位 | |
| description | varchar(255) | 描述 | |
| additional_info | json | 附加信息 | |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

**约束**:
- UNIQUE (device_template_id, data_identifier)

**外键**:
- device_template_id → device_templates(id) ON DELETE CASCADE

#### 2.2.5 device_model_attributes (设备属性模型)

设备属性数据模型定义（结构同遥测模型）

#### 2.2.6 device_model_commands (设备命令模型)

设备命令数据模型定义

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| device_template_id | varchar(36) | 设备模板ID | FK, NOT NULL |
| data_name | varchar(255) | 命令名称 | |
| data_identifier | varchar(255) | 命令标识符 | NOT NULL |
| params | json | 参数定义 | |
| description | varchar(255) | 描述 | |
| additional_info | json | 附加信息 | |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

**约束**:
- UNIQUE (data_identifier, device_template_id)

#### 2.2.7 device_model_events (设备事件模型)

设备事件数据模型定义（结构类似命令模型）

#### 2.2.8 groups (设备分组表)

设备分组表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | 分组ID | PK |
| parent_id | varchar(36) | 父分组ID | DEFAULT 0 |
| tier | int4 | 层级 | DEFAULT 1 |
| name | varchar(255) | 分组名称 | NOT NULL |
| description | varchar(255) | 描述 | |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.2.9 r_group_device (分组设备关联表)

设备与分组的多对多关联表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| group_id | varchar(36) | 分组ID | FK → groups(id) |
| device_id | varchar(36) | 设备ID | FK → devices(id) |
| tenant_id | varchar(36) | 租户ID | NOT NULL |

**约束**:
- UNIQUE (group_id, device_id)

**外键**:
- group_id → groups(id) ON DELETE CASCADE
- device_id → devices(id) ON DELETE CASCADE

#### 2.2.10 products (产品表)

产品管理表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | 产品ID | PK |
| name | varchar(255) | 产品名称 | NOT NULL |
| description | varchar(255) | 描述 | |
| product_type | varchar(36) | 产品类型 | |
| product_key | varchar(255) | 产品Key | |
| product_model | varchar(100) | 产品型号 | |
| image_url | varchar(500) | 产品图片 | |
| device_config_id | varchar(36) | 设备配置ID | FK |
| additional_info | json | 附加信息 | |
| tenant_id | varchar(36) | 租户ID | |
| created_at | timestamptz | 创建时间 | NOT NULL |
| remark | varchar(500) | 备注 | |

**外键**:
- device_config_id → device_configs(id) ON DELETE RESTRICT

### 2.3 设备数据

#### 2.3.1 telemetry_datas (遥测数据表)

设备遥测历史数据表（时序数据 - TimescaleDB超表）

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| device_id | varchar(36) | 设备ID | NOT NULL |
| key | varchar(255) | 数据标识符 | NOT NULL |
| ts | int8 | 时间戳(微秒) | NOT NULL |
| bool_v | bool | 布尔值 | |
| number_v | float8 | 数值 | |
| string_v | text | 字符串值 | |
| tenant_id | varchar(36) | 租户ID | |

**约束**:
- UNIQUE (device_id, key, ts)

**索引**:
- CREATE INDEX telemetry_datas_ts_idx ON telemetry_datas USING btree (ts DESC)

**TimescaleDB配置**:
```sql
SELECT create_hypertable('telemetry_datas', 'ts', chunk_time_interval => 86400000000);
-- 24小时分区
```

#### 2.3.2 telemetry_current_datas (遥测当前值表)

设备遥测当前值表（最新数据）

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| device_id | varchar(36) | 设备ID | NOT NULL |
| key | varchar(255) | 数据标识符 | NOT NULL |
| ts | timestamptz | 上报时间 | NOT NULL |
| bool_v | bool | 布尔值 | |
| number_v | float8 | 数值 | |
| string_v | text | 字符串值 | |
| tenant_id | varchar(36) | 租户ID | |

**约束**:
- UNIQUE (device_id, key)

#### 2.3.3 attribute_datas (属性数据表)

设备属性数据表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| device_id | varchar(36) | 设备ID | FK, NOT NULL |
| key | varchar(255) | 数据标识符 | NOT NULL |
| ts | timestamptz | 上报时间 | NOT NULL |
| bool_v | bool | 布尔值 | |
| number_v | float8 | 数值 | |
| string_v | text | 字符串值 | |
| tenant_id | varchar(36) | 租户ID | |

**约束**:
- UNIQUE (device_id, key)

**外键**:
- device_id → devices(id) ON DELETE RESTRICT

#### 2.3.4 event_datas (事件数据表)

设备事件数据表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| device_id | varchar(36) | 设备ID | FK, NOT NULL |
| identify | varchar(255) | 数据标识符 | NOT NULL |
| ts | timestamptz | 上报时间 | NOT NULL |
| data | json | 事件数据 | |
| tenant_id | varchar(36) | 租户ID | |

**外键**:
- device_id → devices(id) ON DELETE RESTRICT

### 2.4 日志表

#### 2.4.1 operation_logs (操作日志表)

系统操作日志表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| ip | varchar(36) | 请求IP | NOT NULL |
| path | varchar(2000) | 请求路径 | |
| user_id | varchar(36) | 操作用户ID | NOT NULL |
| name | varchar(255) | 接口名称 | |
| latency | int8 | 耗时(ms) | |
| request_message | text | 请求内容 | |
| response_message | text | 响应内容 | |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.4.2 telemetry_set_logs (遥测设置日志)

遥测数据下发日志

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| device_id | varchar(36) | 设备ID | FK, NOT NULL |
| operation_type | varchar(255) | 操作类型 | 1-手动 2-自动 |
| data | json | 发送内容 | |
| status | varchar(2) | 状态 | 1-成功 2-失败 |
| error_message | varchar(500) | 错误信息 | |
| user_id | varchar(36) | 操作用户 | |
| description | varchar(255) | 描述 | |
| created_at | timestamptz | 创建时间 | NOT NULL |

**外键**:
- device_id → devices(id) ON DELETE RESTRICT

#### 2.4.3 attribute_set_logs (属性设置日志)

属性数据下发日志

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| device_id | varchar(36) | 设备ID | FK, NOT NULL |
| operation_type | varchar(255) | 操作类型 | 1-手动 2-自动 |
| message_id | varchar(36) | 消息ID | |
| data | text | 发送内容 | |
| rsp_data | text | 响应内容 | |
| status | varchar(2) | 状态 | 1-成功 2-失败 |
| error_message | varchar(500) | 错误信息 | |
| user_id | varchar(36) | 操作用户 | |
| description | varchar(255) | 描述 | |
| created_at | timestamptz | 创建时间 | NOT NULL |

#### 2.4.4 command_set_logs (命令下发日志)

命令下发日志表结构类似

### 2.5 告警管理

#### 2.5.1 alarm_config (告警配置表)

告警配置表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| name | varchar(255) | 告警名称 | NOT NULL |
| description | varchar(255) | 描述 | |
| alarm_level | varchar(10) | 告警级别 | H-高 M-中 L-低 |
| notification_group_id | varchar(36) | 通知组ID | NOT NULL |
| enabled | varchar(10) | 是否启用 | Y-启用 N-停用 |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.5.2 alarm_info (告警信息表)

告警记录表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| alarm_config_id | varchar(36) | 告警配置ID | FK, NOT NULL |
| name | varchar(255) | 告警名称 | NOT NULL |
| alarm_time | timestamptz | 告警时间 | NOT NULL |
| alarm_level | varchar(10) | 告警级别 | L/M/H |
| description | varchar(255) | 描述 | |
| content | text | 告警内容 | |
| processor | varchar(36) | 处理人ID | |
| processing_result | varchar(10) | 处理结果 | DOP-已处理 UND-未处理 IGN-已忽略 |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| remark | varchar(255) | 备注 | |

**外键**:
- alarm_config_id → alarm_config(id) ON DELETE CASCADE

#### 2.5.3 alarm_history (告警历史表)

告警历史记录表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| alarm_config_id | varchar(36) | 告警配置ID | NOT NULL |
| group_id | varchar(36) | 分组ID | NOT NULL |
| scene_automation_id | varchar(36) | 场景自动化ID | NOT NULL |
| name | varchar(255) | 告警名称 | NOT NULL |
| description | varchar(255) | 描述 | |
| content | text | 内容 | |
| alarm_status | varchar(3) | 告警状态 | L/M/H/N |
| alarm_device_list | jsonb | 触发设备列表 | NOT NULL |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| create_at | timestamptz | 创建时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.5.4 notification_groups (通知组表)

通知组配置表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| name | varchar(99) | 名称 | NOT NULL |
| notification_type | varchar(25) | 通知类型 | MEMBER/EMAIL/SME/VOICE/WEBHOOK |
| status | varchar(10) | 状态 | ON-启用 OFF-停用 |
| notification_config | jsonb | 通知配置 | |
| description | varchar(255) | 描述 | |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.5.5 notification_histories (通知历史表)

通知发送历史表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| send_time | timestamptz | 发送时间 | NOT NULL |
| send_content | text | 发送内容 | |
| send_target | varchar(255) | 发送目标 | NOT NULL |
| send_result | varchar(25) | 发送结果 | SUCCESS/FAILURE |
| notification_type | varchar(25) | 通知类型 | MEMBER/EMAIL/SME/VOICE/WEBHOOK |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| remark | varchar(255) | 备注 | |

### 2.6 自动化

#### 2.6.1 scene_automations (场景自动化表)

场景联动配置表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| name | varchar(255) | 名称 | NOT NULL |
| description | varchar(255) | 描述 | |
| enabled | varchar(10) | 是否启用 | Y-启用 N-停用 |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| creator | varchar(36) | 创建人ID | NOT NULL |
| updator | varchar(36) | 修改人ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | |
| remark | varchar(255) | 备注 | |

#### 2.6.2 device_trigger_condition (设备触发条件表)

设备触发条件配置表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| scene_automation_id | varchar(36) | 场景联动ID | FK, NOT NULL |
| enabled | varchar(10) | 是否启用 | NOT NULL |
| group_id | varchar(36) | 分组ID | NOT NULL |
| trigger_condition_type | varchar(10) | 条件类型 | 10-单设备 11-设备类 2-时间范围 |
| trigger_source | varchar(36) | 触发源 | |
| trigger_param_type | varchar(10) | 参数类型 | TEL/ATTR/EVT/STATUS |
| trigger_param | varchar(50) | 触发参数 | |
| trigger_operator | varchar(10) | 运算符 | =, !=, >, <, >=, <=, between, in |
| trigger_value | varchar(99) | 触发值 | NOT NULL |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| remark | varchar(255) | 备注 | |

**外键**:
- scene_automation_id → scene_automations(id) ON DELETE CASCADE

#### 2.6.3 action_info (动作信息表)

场景联动动作配置表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| scene_automation_id | varchar(36) | 场景联动ID | FK, NOT NULL |
| action_target | varchar(255) | 动作目标ID | |
| action_type | varchar(10) | 动作类型 | 10-单设备 11-设备类 20-激活场景 30-告警 40-服务 |
| action_param_type | varchar(10) | 参数类型 | TEL/ATTR/CMD |
| action_param | varchar(50) | 动作参数 | |
| action_value | text | 目标值 | |
| remark | varchar(255) | 备注 | |

**外键**:
- scene_automation_id → scene_automations(id) ON DELETE CASCADE

#### 2.6.4 one_time_tasks (一次性任务表)

一次性定时任务表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| scene_automation_id | varchar(36) | 场景联动ID | FK, NOT NULL |
| execution_time | timestamptz | 执行时间 | NOT NULL |
| executing_state | varchar(10) | 执行状态 | NEX-未执行 EXE-已执行 EXP-过期 |
| enabled | varchar(10) | 是否启用 | Y-启用 N-停用 |
| expiration_time | int8 | 过期时间(分钟) | NOT NULL |
| remark | varchar(255) | 备注 | |

**外键**:
- scene_automation_id → scene_automations(id) ON DELETE CASCADE

#### 2.6.5 periodic_tasks (周期性任务表)

周期性定时任务表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| scene_automation_id | varchar(36) | 场景联动ID | FK, NOT NULL |
| task_type | varchar(255) | 任务类型 | HOUR/DAY/WEEK/MONTH/CRON |
| params | varchar(50) | 参数 | NOT NULL |
| execution_time | timestamptz | 执行时间 | NOT NULL |
| enabled | varchar(10) | 是否启用 | Y-启用 N-停用 |
| expiration_time | int8 | 过期时间(分钟) | NOT NULL |
| remark | varchar(255) | 备注 | |

**外键**:
- scene_automation_id → scene_automations(id) ON DELETE CASCADE

#### 2.6.6 scene_automation_log (场景自动化日志表)

场景联动执行日志表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| scene_automation_id | varchar(36) | 场景联动ID | FK, NOT NULL |
| executed_at | timestamptz | 执行时间 | NOT NULL |
| detail | text | 执行详情 | NOT NULL |
| execution_result | varchar(10) | 执行结果 | S-成功 F-失败 |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| remark | varchar(255) | 备注 | |

**外键**:
- scene_automation_id → scene_automations(id) ON DELETE RESTRICT

### 2.7 其他核心表

#### 2.7.1 protocol_plugins (协议插件表)

协议插件配置表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| name | varchar(36) | 插件名称 | NOT NULL |
| device_type | int2 | 设备类型 | 1-直连 2-网关 |
| protocol_type | varchar(50) | 协议类型 | NOT NULL |
| access_address | varchar(500) | 接入地址 | |
| http_address | varchar(500) | HTTP服务地址 | |
| sub_topic_prefix | varchar(500) | 订阅主题前缀 | |
| description | varchar(500) | 描述 | |
| additional_info | varchar(1000) | 附加信息 | |
| created_at | timestamptz | 创建时间 | NOT NULL |
| update_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.7.2 ota_upgrade_packages (OTA升级包表)

OTA固件升级包表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| name | varchar(200) | 升级包名称 | NOT NULL |
| version | varchar(36) | 升级包版本 | NOT NULL |
| target_version | varchar(36) | 待升级版本 | |
| device_config_id | varchar(36) | 设备配置ID | NOT NULL |
| module | varchar(36) | 模块名称 | |
| package_type | int2 | 升级包类型 | 1-差分 2-整包 |
| signature_type | varchar(36) | 签名算法 | MD5/SHA256 |
| signature | varchar(255) | 签名 | |
| package_url | varchar(500) | 包下载路径 | |
| description | varchar(500) | 描述 | |
| additional_info | json | 附加信息 | DEFAULT '{}' |
| tenant_id | varchar(36) | 租户ID | |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | |
| remark | varchar(255) | 备注 | |

#### 2.7.3 ota_upgrade_tasks (OTA升级任务表)

OTA升级任务表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| name | varchar(200) | 任务名称 | NOT NULL |
| ota_upgrade_package_id | varchar(36) | 升级包ID | FK, NOT NULL |
| description | varchar(500) | 描述 | |
| created_at | timestamptz | 创建时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.7.4 ota_upgrade_task_details (OTA升级任务详情表)

OTA升级任务详情表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| ota_upgrade_task_id | varchar(200) | 升级任务ID | FK, NOT NULL |
| device_id | varchar(200) | 设备ID | FK, NOT NULL |
| steps | int2 | 升级进度 | 1-100 |
| status | int2 | 状态 | 1-待推送 2-已推送 3-升级中 4-成功 5-失败 6-已取消 |
| status_description | varchar(500) | 状态描述 | |
| updated_at | timestamptz | 更新时间 | |
| remark | varchar(255) | 备注 | |

**外键**:
- ota_upgrade_task_id → ota_upgrade_tasks(id) ON DELETE CASCADE
- device_id → devices(id) ON DELETE RESTRICT

#### 2.7.5 boards (看板表)

监控看板配置表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| name | varchar(255) | 看板名称 | NOT NULL |
| config | json | 看板配置 | DEFAULT '{}' |
| description | varchar(500) | 描述 | |
| home_flag | varchar(2) | 首页标志 | Y/N |
| menu_flag | varchar(2) | 菜单标志 | Y/N |
| tenant_id | varchar(36) | 租户ID | NOT NULL |
| created_at | timestamptz | 创建时间 | NOT NULL |
| updated_at | timestamptz | 更新时间 | NOT NULL |
| remark | varchar(255) | 备注 | |

#### 2.7.6 data_policy (数据策略表)

数据清理策略表

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | varchar(36) | ID | PK |
| data_type | varchar(1) | 清理类型 | 1-设备数据 2-操作日志 |
| retention_days | int4 | 保留天数 | NOT NULL |
| last_cleanup_time | timestamptz | 上次清理时间 | |
| last_cleanup_data_time | timestamptz | 上次清理数据时间节点 | |
| enabled | varchar(1) | 是否启用 | 1-启用 2-停用 |
| remark | varchar(255) | 备注 | |

## 3. 数据库关系图

### 3.1 核心表关系

```
users (用户)
  ↓
tenants (租户) ← tenant_id
  ↓
┌─────────────────────────────────────────┐
│  devices (设备)                         │
├─────────────────────────────────────────┤
│  ↑                                      │
│  ├─ device_configs (设备配置)            │
│  │   ↑                                 │
│  │   └─ device_templates (设备模板)     │
│  │       ├─ device_model_telemetry     │
│  │       ├─ device_model_attributes    │
│  │       ├─ device_model_commands      │
│  │       └─ device_model_events        │
│  │                                     │
│  └─ products (产品)                     │
│      └─ device_configs                 │
└─────────────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────────────┐
│  设备数据                                │
├─────────────────────────────────────────┤
│  ├─ telemetry_datas (遥测历史)          │
│  ├─ telemetry_current_datas (遥测当前)  │
│  ├─ attribute_datas (属性)              │
│  └─ event_datas (事件)                  │
└─────────────────────────────────────────┘
```

### 3.2 自动化关系

```
scene_automations (场景自动化)
  ├─ device_trigger_condition (触发条件)
  ├─ one_time_tasks (一次性任务)
  ├─ periodic_tasks (周期性任务)
  ├─ action_info (动作信息)
  └─ scene_automation_log (执行日志)
```

### 3.3 告警关系

```
alarm_config (告警配置)
  ├─ notification_groups (通知组)
  │   └─ notification_histories (通知历史)
  ├─ alarm_info (告警信息)
  └─ alarm_history (告警历史)
```

## 4. 数据库优化建议

### 4.1 索引优化

**推荐添加的索引:**

```sql
-- 设备表
CREATE INDEX idx_devices_tenant_id ON devices(tenant_id);
CREATE INDEX idx_devices_is_online ON devices(is_online);
CREATE INDEX idx_devices_device_config_id ON devices(device_config_id);
CREATE INDEX idx_devices_product_id ON devices(product_id);

-- 遥测数据表
-- 已有ts索引，可添加device_id索引
CREATE INDEX idx_telemetry_datas_device_id ON telemetry_datas(device_id);
CREATE INDEX idx_telemetry_current_datas_device_id ON telemetry_current_datas(device_id);

-- 操作日志表
CREATE INDEX idx_operation_logs_tenant_id ON operation_logs(tenant_id);
CREATE INDEX idx_operation_logs_user_id ON operation_logs(user_id);
CREATE INDEX idx_operation_logs_created_at ON operation_logs(created_at DESC);

-- 告警信息表
CREATE INDEX idx_alarm_info_tenant_id ON alarm_info(tenant_id);
CREATE INDEX idx_alarm_info_alarm_time ON alarm_info(alarm_time DESC);
```

### 4.2 分区表优化

对于大数据量表，建议使用分区：

```sql
-- 操作日志按月分区
CREATE TABLE operation_logs_2025_01 PARTITION OF operation_logs
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE operation_logs_2025_02 PARTITION OF operation_logs
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```

### 4.3 TimescaleDB优化

```sql
-- 设置数据保留策略（保留30天）
SELECT add_retention_policy('telemetry_datas', INTERVAL '30 days');

-- 启用压缩
ALTER TABLE telemetry_datas SET (
  timescaledb.compress,
  timescaledb.compress_segmentby = 'device_id'
);

-- 添加压缩策略
SELECT add_compression_policy('telemetry_datas', INTERVAL '7 days');
```

### 4.4 连接池配置

```yaml
db:
  psql:
    idle_conns: 5      # 空闲连接数
    open_conns: 50     # 最大连接数
```

## 5. 数据迁移

### 5.1 版本升级

按顺序执行SQL脚本：
```bash
psql -U postgres -d ThingsPanel -f sql/1.sql
psql -U postgres -d ThingsPanel -f sql/2.sql
# ... 依次执行
```

### 5.2 数据备份

```bash
# 完整备份
pg_dump -U postgres -d ThingsPanel -F c -f backup.dump

# 仅备份表结构
pg_dump -U postgres -d ThingsPanel --schema-only -f schema.sql

# 仅备份数据
pg_dump -U postgres -d ThingsPanel --data-only -f data.sql
```

### 5.3 数据恢复

```bash
# 从备份恢复
pg_restore -U postgres -d ThingsPanel -c backup.dump
```

## 6. 性能监控

### 6.1 慢查询日志

配置 `postgresql.conf`:
```ini
log_min_duration_statement = 200  # 记录超过200ms的查询
```

### 6.2 查询统计

```sql
-- 启用pg_stat_statements扩展
CREATE EXTENSION pg_stat_statements;

-- 查看慢查询
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

### 6.3 表大小监控

```sql
-- 查看表大小
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

---

**文档版本**: v1.0  
**最后更新**: 2025-12-01
