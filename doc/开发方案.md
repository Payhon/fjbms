# ThingsPanel BMS 二次开发方案

## 1. 项目概述

### 1.1 目标
基于 ThingsPanel 现有架构，开发一套 BMS (电池管理系统) 物联网平台。系统需支持 Web 端管理平台（厂家/经销商）和 多端 APP（终端用户/运维），实现电池全生命周期管理。

### 1.2 核心差异分析
| 模块 | 现有 ThingsPanel 能力 | BMS 项目新增需求 | 开发策略 |
| :--- | :--- | :--- | :--- |
| **用户体系** | 租户/用户/角色 (RBAC) | 三级架构：厂家 -> 经销商 -> 终端用户 | 基于现有租户体系扩展，增加`dealers`表，复用`users`表但增加角色标识。 |
| **设备管理** | 通用设备接入、属性/遥测 | 电池专有属性(SOC/SOH)、生命周期(出厂/转移/激活) | 扩展设备模型，新增`battery_models`和`device_lifecycle`相关表。 |
| **通信方式** | MQTT | MQTT + **蓝牙 (BLE)** | APP端新增蓝牙模块，实现近场通信；后端保持MQTT处理远程数据。 |
| **业务流程** | 告警、自动化 | 维保申请、审批、退换货、OTA升级 | 新增独立的业务模块（维保、售后）。 |

---

## 2. 系统架构设计

### 2.1 总体架构
沿用 ThingsPanel 的前后端分离架构：
- **后端**: Golang + Gin + GORM + TimescaleDB + Redis + MQTT Broker
- **Web端**: Vue 3 + Element Plus
- **App端**: Uni-app (iOS/Android/小程序)

### 2.2 角色权限设计 (基于 Casbin)
1.  **厂家管理员 (Manufacturer Admin)**:
    -   拥有 `sys_admin` 或特定 `tenant_admin` 权限。
    -   全权管理：设备导入、经销商管理、OTA发布、维保终审。
2.  **经销商管理员 (Dealer Admin)**:
    -   新增角色 `dealer_admin`。
    -   数据隔离：只能查看/操作 `dealer_id` 关联的设备和用户。
    -   权限：设备转移(向下)、维保申请、用户管理。
3.  **终端用户 (End User)**:
    -   新增角色 `end_user`。
    -   权限：仅限查看自己绑定的设备 (`device_user_binding`)，提交维保。

---

## 3. 数据库设计方案

需在现有数据库基础上新增以下核心表：

### 3.1 经销商与用户体系
```sql
-- 经销商表
CREATE TABLE dealers (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    contact_person VARCHAR(100),
    phone VARCHAR(50),
    email VARCHAR(100),
    region VARCHAR(100), -- 省市区
    address VARCHAR(255),
    parent_id VARCHAR(36), -- 支持多级经销商
    tenant_id VARCHAR(36) NOT NULL, -- 归属租户
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 扩展 users 表 (或通过 additional_info 字段)
-- 建议在 users 表增加 dealer_id 字段关联经销商
ALTER TABLE users ADD COLUMN dealer_id VARCHAR(36);
```

### 3.2 电池业务模型
```sql
-- 电池型号表 (标准化参数)
CREATE TABLE battery_models (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    voltage_rated FLOAT, -- 额定电压
    capacity_rated FLOAT, -- 额定容量
    cell_count INT, -- 电芯数量
    warranty_months INT, -- 质保期(月)
    description TEXT
);

-- 设备扩展信息表 (一对一关联 devices)
CREATE TABLE device_batteries (
    device_id VARCHAR(36) PRIMARY KEY REFERENCES devices(id),
    battery_model_id VARCHAR(36) REFERENCES battery_models(id),
    dealer_id VARCHAR(36) REFERENCES dealers(id), -- 当前归属经销商
    production_date DATE, -- 出厂日期
    warranty_expire_date DATE, -- 质保到期日
    activation_date TIMESTAMPTZ, -- 激活时间
    activation_status VARCHAR(20) DEFAULT 'INACTIVE', -- INACTIVE, ACTIVE
    transfer_status VARCHAR(20) DEFAULT 'FACTORY', -- FACTORY, DEALER, USER
    batch_number VARCHAR(100) -- 批次号
);

-- 设备转移记录
CREATE TABLE device_transfers (
    id VARCHAR(36) PRIMARY KEY,
    device_id VARCHAR(36) NOT NULL,
    from_dealer_id VARCHAR(36), -- 空代表厂家
    to_dealer_id VARCHAR(36),
    operator_id VARCHAR(36),
    transfer_time TIMESTAMPTZ DEFAULT NOW(),
    remark TEXT
);

-- 终端用户绑定关系
CREATE TABLE device_user_bindings (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    device_id VARCHAR(36) NOT NULL,
    binding_time TIMESTAMPTZ DEFAULT NOW(),
    is_owner BOOLEAN DEFAULT FALSE -- 是否为主用户
);
```

### 3.3 售后与维保
```sql
-- 维保申请表
CREATE TABLE warranty_applications (
    id VARCHAR(36) PRIMARY KEY,
    device_id VARCHAR(36) NOT NULL,
    user_id VARCHAR(36) NOT NULL, -- 申请人
    type VARCHAR(20), -- REPAIR(维修), RETURN(退货), EXCHANGE(换货)
    description TEXT,
    images JSONB, -- 图片附件URL列表
    status VARCHAR(20), -- PENDING, APPROVED, REJECTED, PROCESSING, COMPLETED
    result_info JSONB, -- 维修结果/驳回原因
    handler_id VARCHAR(36), -- 处理人
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ
);
```

---

## 4. 后端开发方案 (Golang)

### 4.1 模块划分
在 `backend/internal/app` 下新增以下模块：
1.  **`dealer`**: 处理经销商的增删改查、层级管理。
2.  **`battery`**:
    -   `Service`: 处理电池全生命周期逻辑（入库、转移、激活）。
    -   `Import`: Excel 批量导入解析。
3.  **`warranty`**: 维保工单流转逻辑。
4.  **`app_api`**: 专门为 APP 端提供的聚合 API（简化认证、聚合数据）。

### 4.2 核心逻辑实现
-   **设备转移**:
    -   API: `POST /api/v1/battery/transfer`
    -   逻辑: 校验当前归属 -> 更新 `device_batteries.dealer_id` -> 插入 `device_transfers` 记录。
-   **设备激活**:
    -   API: `POST /api/v1/app/device/bind`
    -   逻辑: 校验设备合法性 -> 建立 `device_user_bindings` -> 更新 `device_batteries.activation_status` -> 记录激活日志。
-   **数据权限中间件**:
    -   实现 `DealerAuthMiddleware`，拦截请求并校验 `user.dealer_id` 是否匹配目标资源的 `dealer_id`。

---

## 5. Web 端开发方案 (Vue 3)

### 5.1 目录结构调整
在 `src/views` 下新增 `bms` 目录：
```
src/views/bms/
├── dashboard/          # 差异化仪表盘 (厂家/经销商)
├── dealer/             # 经销商管理
├── battery/
│   ├── list.vue        # 电池列表 (含导入/转移功能)
│   ├── model.vue       # 型号管理
│   └── lifecycle.vue   # 生命周期记录
├── warranty/           # 维保中心
└── ota/                # OTA 升级管理 (复用或增强现有OTA)
```

### 5.2 关键功能实现
1.  **动态仪表盘**:
    -   根据登录用户角色 (`sys_admin` vs `dealer_admin`) 加载不同的 Dashboard 组件。
    -   使用 ECharts 绘制地图和趋势图。
2.  **批量导入组件**:
    -   使用 `xlsx` 库前端解析 Excel，预览数据后提交后端。
3.  **地图组件**:
    -   集成高德/百度地图 API，展示设备聚合点。

---

## 6. APP 端开发方案 (Uni-app)

### 6.1 技术选型
-   **框架**: Uni-app (Vue 3)
-   **UI库**: uView UI 2.0
-   **蓝牙**: uni-app 原生 BLE API

### 6.2 核心模块
1.  **蓝牙通信模块 (`utils/ble.js`)**:
    -   封装 `openBluetoothAdapter`, `createBLEConnection`, `notifyBLECharacteristicValueChange`。
    -   实现数据包的分包发送和组包接收（解决 BLE MTU 限制）。
    -   定义私有协议解析器，将二进制数据转换为 JSON 对象（电压、电流、电芯数据）。
2.  **双模通信策略**:
    -   **自动切换**: 优先检测蓝牙信号，若连接成功则走蓝牙通道（实时性高、免费）；若蓝牙断开，自动降级为 MQTT 通道（远程控制）。
    -   **UI 表现**: 界面顶部显示当前连接模式图标（蓝牙/云端）。
3.  **扫码绑定**:
    -   调用 `uni.scanCode` 获取设备二维码信息（加密字符串）。
    -   解析出 `device_number` 和 `secret`，调用后端绑定接口。
4.  **电池详情页**:
    -   **仪表盘**: 使用 Canvas 绘制动态仪表盘（电压/SOC）。
    -   **电芯视图**: 使用 Flex 布局渲染电芯矩阵，异常电芯高亮显示。

---

## 7. 开发进度规划 (Roadmap)

### 第一阶段：基础建设与数据模型 (2周)
-   [后端] 数据库表结构创建 (`dealers`, `battery_models`, `device_batteries` 等)。
-   [后端] 完成经销商管理 API、电池型号管理 API。
-   [后端] 设备导入与分配逻辑实现。

### 第二阶段：Web 管理平台开发 (3周)
-   [前端] 厂家/经销商 差异化 Dashboard。
-   [前端] 电池列表页（查询、转移、详情）。
-   [前端] 经销商管理页。
-   [联调] Web 端与后端接口联调。

### 第三阶段：APP 核心功能开发 (4周)
-   [APP] 框架搭建，登录/注册/找回密码页面。
-   [APP] 扫码绑定与设备列表。
-   [APP] **蓝牙通信模块开发与调试** (重点/难点)。
-   [APP] 电池详情页与实时数据展示。

### 第四阶段：业务闭环与优化 (3周)
-   [全端] 维保/售后流程开发 (APP提交 -> Web审核)。
-   [全端] OTA 升级流程 (APP 蓝牙OTA + Web 远程OTA)。
-   [测试] 蓝牙兼容性测试、高并发数据上报测试。
-   [部署] 生产环境部署。

---

## 8. 重点难点与解决方案

1.  **蓝牙与MQTT的数据一致性**:
    -   **问题**: APP 通过蓝牙控制设备后，云端状态可能未同步。
    -   **解法**: 设备端在接收蓝牙指令执行成功后，需立即触发一次 MQTT 状态上报。
2.  **APP 蓝牙兼容性**:
    -   **问题**: Android 碎片化严重，部分机型 BLE 连接不稳定。
    -   **解法**: 建立机型白名单/黑名单；连接失败增加重试机制；使用标准 BLE 协议栈。
3.  **大量设备数据的实时监控**:
    -   **问题**: 首页地图加载数万设备可能卡顿。
    -   **解法**: 后端实现基于地理位置的聚合算法 (GeoHash)，前端仅渲染聚合点；列表页使用分页+虚拟滚动。

---
**文档版本**: v1.0
**日期**: 2025-12-01
