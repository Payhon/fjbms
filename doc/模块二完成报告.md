# æ¨¡å—äºŒï¼šè®¾å¤‡ç»‘å®šä¸ç»´ä¿åŠŸèƒ½ - å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2025-12-03 10:00  
**æ¨¡å—çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆåç«¯ + Web ç®¡ç†ç«¯å…¥å£ï¼‰

---

## ğŸ“¦ äº¤ä»˜å†…å®¹

### 1. åç«¯ Service å±‚

#### âœ… `/backend/internal/service/device_binding.go`
è®¾å¤‡ç»‘å®šæœåŠ¡ï¼ˆAPP ç«¯æ¿€æ´»ï¼‰ï¼ŒåŒ…å«ï¼š
- `BindDevice`  
  - æŒ‰è®¾å¤‡ç¼–å· + ç§Ÿæˆ·æ ¡éªŒè®¾å¤‡åˆæ³•æ€§  
  - å¯é€‰æ ¡éªŒè®¾å¤‡å¯†é’¥ï¼ˆå¯¹æ¯” `devices.voucher`ï¼‰  
  - åˆ›å»º `device_user_bindings` è®°å½•ï¼ˆé¦–ä¸ªç»‘å®šç”¨æˆ·æ ‡è®° `is_owner=true`ï¼‰  
  - æ›´æ–° `device_batteries.activation_status` ä¸º `ACTIVE`ï¼Œ`transfer_status` ä¸º `USER`ï¼Œå†™å…¥ `activation_date`
- `UnbindDevice`  
  - åˆ é™¤å½“å‰ç”¨æˆ·ä¸è®¾å¤‡é—´çš„ç»‘å®šå…³ç³»  
  - å½“è®¾å¤‡æ— ä»»ä½•ç»‘å®šå…³ç³»æ—¶ï¼Œé‡ç½®æ¿€æ´»çŠ¶æ€ä¸º `INACTIVE`ï¼Œå¹¶æŒ‰æ˜¯å¦æœ‰ `dealer_id` å›é€€æµè½¬çŠ¶æ€ä¸º `DEALER/FACTORY`
- `GetUserDevices`  
  - æ”¯æŒæŒ‰ `user_id`ã€`device_number` æŸ¥è¯¢  
  - å…³è”ç”¨æˆ·ä¸è®¾å¤‡ä¿¡æ¯ï¼Œè¿”å›ç”¨æˆ·ç»‘å®šè®¾å¤‡åˆ—è¡¨

#### âœ… `/backend/internal/service/warranty.go`
ç»´ä¿ç®¡ç†æœåŠ¡ï¼ŒåŒ…å«ï¼š
- `CreateWarrantyApplication` - åˆ›å»ºç»´ä¿ç”³è¯·  
  - æ ¡éªŒè®¾å¤‡ä¸ç§Ÿæˆ·  
  - å½“å‰ç™»å½•ç”¨æˆ·ä½œä¸ºç”³è¯·äºº  
  - å°†å›¾ç‰‡ URL åˆ—è¡¨åºåˆ—åŒ–å­˜å…¥ `warranty_applications.images`
- `UpdateWarrantyStatus` - æ›´æ–°ç”³è¯·çŠ¶æ€  
  - æ”¯æŒæ›´æ–° `status` ä¸ `result_info`ï¼ˆJSONï¼‰  
  - å¤„ç†äººé»˜è®¤ä¸ºå½“å‰ç”¨æˆ·ï¼ˆå¦‚æœªæŒ‡å®šä¸”åŸè®°å½•ä¸ºç©ºï¼‰
- `GetWarrantyList` - ç»´ä¿åˆ—è¡¨æŸ¥è¯¢  
  - æ”¯æŒæŒ‰è®¾å¤‡ç¼–å·ã€ç”³è¯·äººã€ç±»å‹ã€çŠ¶æ€ã€æ—¶é—´èŒƒå›´ç­›é€‰  
  - åˆ†é¡µè¿”å›ï¼Œé™„å¸¦è®¾å¤‡ä¸ç”¨æˆ·ä¿¡æ¯
- `GetWarrantyDetail` - ç»´ä¿ç”³è¯·è¯¦æƒ…  
  - è¿”å›è®¾å¤‡ä¿¡æ¯ã€ç”³è¯·äºº/å¤„ç†äººã€å¤„ç†ç»“æœç­‰å®Œæ•´æ•°æ®

---

### 2. åç«¯ API å±‚ä¸è·¯ç”±

#### âœ… `/backend/internal/api/device_binding.go`
APP è®¾å¤‡ç»‘å®š APIï¼Œè·¯ç”±ï¼š
- `POST /api/v1/app/device/bind` - è®¾å¤‡ç»‘å®šï¼ˆæ‰«ç æ¿€æ´»å…¥å£ï¼‰  
- `POST /api/v1/app/device/unbind` - è®¾å¤‡è§£ç»‘  
- `GET /api/v1/app/device/list` - å½“å‰ç”¨æˆ·ç»‘å®šè®¾å¤‡åˆ—è¡¨

#### âœ… `/backend/internal/api/warranty.go`
ç»´ä¿ç®¡ç† APIï¼Œè·¯ç”±ï¼š
- `POST /api/v1/warranty` - åˆ›å»ºç»´ä¿ç”³è¯·  
- `PUT /api/v1/warranty/{id}` - æ›´æ–°ç»´ä¿ç”³è¯·çŠ¶æ€/å¤„ç†ç»“æœ  
- `GET /api/v1/warranty` - ç»´ä¿ç”³è¯·åˆ—è¡¨  
- `GET /api/v1/warranty/{id}` - ç»´ä¿ç”³è¯·è¯¦æƒ…

#### âœ… è·¯ç”±æ³¨å†Œ
- `/backend/router/apps/device_binding.go` - APP è®¾å¤‡ç»‘å®šè·¯ç”±  
- `/backend/router/apps/warranty.go` - ç»´ä¿ç®¡ç†è·¯ç”±  
- æ›´æ–°ï¼š
  - `/backend/router/apps/enter.go` - æ³¨å†Œ BMS æ–°æ¨¡å—  
  - `/backend/router/router_init.go` - å°†è®¾å¤‡ç»‘å®šã€ç»´ä¿è·¯ç”±æŒ‚è½½åˆ° BMS åˆ†ç»„

#### âœ… æƒé™ä¸­é—´ä»¶
- `/backend/internal/middleware/dealer_auth.go`  
  - ä» `users.dealer_id` è¯»å–å½“å‰ç”¨æˆ·ç»é”€å•†ä¿¡æ¯  
  - å°† `dealer_id` å†™å…¥ Gin Contextï¼Œä¾›åç»­æœåŠ¡è¿›è¡Œç»é”€å•†ç»´åº¦æ•°æ®æ§åˆ¶  
  - åœ¨ BMS ç›¸å…³è·¯ç”±åˆ†ç»„ä¸ŠæŒ‚è½½

---

### 3. Web ç®¡ç†ç«¯ï¼ˆBMS æ¨¡å—ï¼‰

#### âœ… API å°è£…
- `/frontend/src/service/api/bms.ts`
  - `getDealerList / createDealer / updateDealer / deleteDealer`  
  - `getBatteryModelList / createBatteryModel / updateBatteryModel / deleteBatteryModel`  
  - `transferDevices / getTransferHistory`  
  - `getWarrantyList / getWarrantyDetail / createWarranty / updateWarrantyStatus`

#### âœ… é¡µé¢ç»„ä»¶
- ç»é”€å•†ç®¡ç†  
  - `src/views/bms/dealer/index.vue`  
  - `src/views/bms/dealer/modules/dealer-modal.vue`
- ç”µæ± å‹å·ç®¡ç†  
  - `src/views/bms/battery/model.vue`  
  - `src/views/bms/battery/modules/battery-model-modal.vue`
- è®¾å¤‡è½¬ç§»è®°å½•  
  - `src/views/bms/battery/transfer.vue`
- ç»´ä¿ä¸­å¿ƒ  
  - `src/views/bms/warranty/index.vue`  
  - åˆ—è¡¨ + æœç´¢ï¼ˆè®¾å¤‡ç¼–å·/ç±»å‹/çŠ¶æ€/æ—¶é—´ï¼‰  
  - è¯¦æƒ…å¼¹çª—ï¼ˆè®¾å¤‡ã€ç”³è¯·äººã€å¤„ç†ç»“æœï¼‰  
  - å¤„ç†å¼¹çª—ï¼ˆæ›´æ–°çŠ¶æ€ + å¤„ç†è¯´æ˜ï¼‰

#### âœ… è·¯ç”±ä¸èœå•
- `src/router/routes/index.ts`  
  - `/bms` â†’ BMS ç®¡ç†  
  - `/bms/dealer` â†’ ç»é”€å•†ç®¡ç†  
  - `/bms/battery/model` â†’ ç”µæ± å‹å·ç®¡ç†  
  - `/bms/battery/transfer` â†’ è®¾å¤‡è½¬ç§»è®°å½•  
  - `/bms/warranty` â†’ ç»´ä¿ä¸­å¿ƒ
- `src/router/elegant/*` ä¸ `src/typings/elegant-router.d.ts`  
  - ä¸º `bms_dealer / bms_battery_model / bms_battery_transfer / bms_warranty` è¡¥é½ç±»å‹ä¸æ˜ å°„  
- `src/locales/langs/zh-cn/route.json`  
  - èœå•æ–‡æ¡ˆï¼š`BMSç®¡ç† / ç»é”€å•†ç®¡ç† / ç”µæ± å‹å·ç®¡ç† / è®¾å¤‡è½¬ç§»è®°å½• / ç»´ä¿ä¸­å¿ƒ`

---

## ğŸ¯ åŠŸèƒ½éªŒè¯æ¸…å•ï¼ˆæµ‹è¯•æŒ‡å¼•ï¼‰

### 1. è®¾å¤‡ç»‘å®šï¼ˆAPP åç«¯æ¥å£ï¼‰
- [ ] ä½¿ç”¨åˆæ³•çš„ `device_number` + æ­£ç¡® `device_secret` è°ƒç”¨ `POST /api/v1/app/device/bind`  
  - æœŸæœ›ï¼š  
    - è¿”å›æˆåŠŸ  
    - `device_user_bindings` æ–°å¢è®°å½•  
    - `device_batteries.activation_status = 'ACTIVE'` ä¸” `transfer_status = 'USER'`
- [ ] é‡å¤ç»‘å®šåŒä¸€è®¾å¤‡  
  - æœŸæœ›ï¼šè¿”å›â€œå·²ç»‘å®šå½“å‰ç”¨æˆ·â€çš„ä¸šåŠ¡é”™è¯¯
- [ ] è°ƒç”¨ `GET /api/v1/app/device/list`  
  - æœŸæœ›ï¼šè¿”å›å½“å‰ç”¨æˆ·å·²ç»‘å®šè®¾å¤‡åˆ—è¡¨
- [ ] è°ƒç”¨ `POST /api/v1/app/device/unbind`  
  - æœŸæœ›ï¼šåˆ é™¤å½“å‰ç”¨æˆ·ç»‘å®šå…³ç³»ï¼›å½“æ— å…¶å®ƒç»‘å®šå…³ç³»æ—¶ï¼Œæ¿€æ´»çŠ¶æ€é‡ç½®ä¸º `INACTIVE`

### 2. ç»´ä¿ç®¡ç†
- [ ] ä½¿ç”¨ç»‘å®šè®¾å¤‡ ID åˆ›å»ºç»´ä¿ç”³è¯· `POST /api/v1/warranty`  
  - æœŸæœ›ï¼šè¿”å›ç”³è¯·è®°å½•ï¼ŒçŠ¶æ€ä¸º `PENDING`
- [ ] æŸ¥è¯¢ç»´ä¿åˆ—è¡¨ `GET /api/v1/warranty`  
  - æœŸæœ›ï¼šèƒ½æŒ‰è®¾å¤‡ç¼–å·ã€çŠ¶æ€ã€ç±»å‹è¿‡æ»¤
- [ ] æŸ¥çœ‹è¯¦æƒ… `GET /api/v1/warranty/{id}`  
  - æœŸæœ›ï¼šåŒ…å«è®¾å¤‡ã€ç”³è¯·äººã€å¤„ç†äººä¿¡æ¯åŠå›¾ç‰‡/å¤„ç†ç»“æœ
- [ ] æ›´æ–°çŠ¶æ€ `PUT /api/v1/warranty/{id}`  
  - æœŸæœ›ï¼šçŠ¶æ€å˜æ›´ï¼Œ`result_info` æ­£å¸¸ä¿å­˜ï¼Œå¤„ç†äººè®°å½•æ­£ç¡®

### 3. Web ç®¡ç†ç«¯
- [ ] å·¦ä¾§èœå•å‡ºç° â€œBMS ç®¡ç†â€ â†’ â€œç»´ä¿ä¸­å¿ƒâ€  
- [ ] ç»´ä¿ä¸­å¿ƒåˆ—è¡¨ä¸æ¥å£ä¸€è‡´ï¼Œç­›é€‰æ¡ä»¶å·¥ä½œæ­£å¸¸  
- [ ] ç‚¹å‡»â€œæŸ¥çœ‹â€ï¼šå¼¹å‡ºè¯¦æƒ…å¼¹çª—ï¼Œæ•°æ®ä¸æ¥å£è¿”å›ä¸€è‡´  
- [ ] ç‚¹å‡»â€œå¤„ç†â€ï¼šæ›´æ–°çŠ¶æ€åï¼Œåˆ—è¡¨çŠ¶æ€åŒæ­¥å˜åŒ–

---

## ğŸ“Š ä¸»è¦ API æ¸…å•ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|---------|------|------|------|
| /api/v1/app/device/bind | POST | è®¾å¤‡ç»‘å®š | APP æ‰«ç æ¿€æ´»å…¥å£ |
| /api/v1/app/device/unbind | POST | è®¾å¤‡è§£ç»‘ | è§£ç»‘å½“å‰ç”¨æˆ·ä¸è®¾å¤‡å…³ç³» |
| /api/v1/app/device/list | GET | ç”¨æˆ·ç»‘å®šè®¾å¤‡åˆ—è¡¨ | é»˜è®¤æŸ¥è¯¢å½“å‰ç™»å½•ç”¨æˆ· |
| /api/v1/warranty | POST | åˆ›å»ºç»´ä¿ç”³è¯· | APP æäº¤ç»´ä¿å·¥å• |
| /api/v1/warranty | GET | ç»´ä¿ç”³è¯·åˆ—è¡¨ | Web ç«¯ç»´ä¿ä¸­å¿ƒåˆ—è¡¨ |
| /api/v1/warranty/{id} | GET | ç»´ä¿è¯¦æƒ… | Web ç«¯æŸ¥çœ‹è¯¦æƒ… |
| /api/v1/warranty/{id} | PUT | æ›´æ–°ç»´ä¿çŠ¶æ€ | Web ç«¯å®¡æ ¸/å¤„ç† |

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹ä¸æ³¨æ„äº‹é¡¹

1. **äº‹åŠ¡å¤„ç†**  
   - è®¾å¤‡ç»‘å®šä¸è§£ç»‘æ¶‰åŠå¤šè¡¨æ›´æ–°ï¼Œå‡åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¼‚å¸¸æ—¶å›æ»šã€‚

2. **å¤šç§Ÿæˆ·ä¸ç»é”€å•†ä¸Šä¸‹æ–‡**  
   - æ‰€æœ‰æŸ¥è¯¢å‡æ ¡éªŒ `tenant_id`ï¼Œå¹¶é€šè¿‡ `DealerAuthMiddleware` æä¾› `dealer_id` ä¸Šä¸‹æ–‡ï¼Œä¾¿äºåç»­ç»†ç²’åº¦æ•°æ®æƒé™æ§åˆ¶ã€‚

3. **å‰åç«¯å­—æ®µæ˜ å°„**  
   - ç»´ä¿æ¥å£ä¸­ `images` ä¸ `result_info` ä½¿ç”¨ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œå‰ç«¯ç”¨å¯¹è±¡/æ•°ç»„ç›´æ¥æ¥æ”¶ã€‚

4. **æµ‹è¯•ç¯å¢ƒå»ºè®®**  
   - æœ¬åœ°å»ºè®®ä½¿ç”¨ `conf-dev.yml` + `sql/1.sql ~ 13.sql` å®Œæ•´åˆå§‹åŒ–æ•°æ®åº“ï¼›  
   - ä½¿ç”¨ Postman/Apifox å¯¼å…¥ä»¥ä¸Š API æ¸…å•ï¼Œç»“åˆ Web ç«¯é¡µé¢å®Œæˆç«¯åˆ°ç«¯è”è°ƒã€‚

---

**ç»“è®º**: æ¨¡å—äºŒï¼ˆè®¾å¤‡ç»‘å®šä¸ç»´ä¿ï¼‰çš„åç«¯æœåŠ¡ã€APIã€Web ç®¡ç†ç«¯å…¥å£å·²å¼€å‘å®Œæˆå¹¶è‡ªæ´½ï¼Œå·²å…·å¤‡ç«¯åˆ°ç«¯è”è°ƒä¸æµ‹è¯•æ¡ä»¶ã€‚åç»­å¯åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­æ‰©å±• APP ç«¯è“ç‰™é€šä¿¡ä¸æ‰«ç ç»‘å®šæµç¨‹ã€‚  

