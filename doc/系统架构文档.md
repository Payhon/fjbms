# ThingsPanel (FJBMS) 系统架构文档

## 1. 项目概述

ThingsPanel是一款**轻量级、组件化**的开源物联网应用支撑平台，旨在通过可复用的插件，减少开发工作，加速物联网项目构建。

### 1.1 项目结构

本项目包含三个主要部分：

```
fjbms/
├── backend/          # 后端服务（Golang）
├── frontend/         # Web前端（Vue.js 3）
└── fjbms-uniapp/    # 移动端APP（Uniapp）
```

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层 (Client Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│  Web前端(Vue3)  │  移动APP(Uniapp)  │  第三方API  │  设备SDK     │
└────────┬────────┴───────────┬───────┴─────┬──────┴─────┬────────┘
         │                    │             │            │
         ▼                    ▼             ▼            ▼
┌─────────────────────────────────────────────────────────────────┐
│                     接入层 (Access Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  HTTP/HTTPS(9999)  │  WebSocket  │  MQTT(1883)  │  gRPC(50052) │
└────────┬───────────┴──────┬──────┴──────┬────────┴──────┬───────┘
         │                  │             │               │
         ▼                  ▼             ▼               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    应用服务层 (Service Layer)                    │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌──────────┐ │
│  │  HTTP服务  │  │ MQTT服务   │  │  gRPC服务  │  │ 定时任务 │ │
│  └────────────┘  └────────────┘  └────────────┘  └──────────┘ │
│                                                                 │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌──────────┐ │
│  │ Uplink流   │  │ Downlink流 │  │ Storage层  │  │ 诊断服务 │ │
│  └────────────┘  └────────────┘  └────────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────────────┘
         │                  │             │               │
         ▼                  ▼             ▼               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      业务逻辑层 (Logic Layer)                    │
├─────────────────────────────────────────────────────────────────┤
│  设备管理  │  用户管理  │  权限管理  │  告警管理  │  自动化     │
│  数据处理  │  协议插件  │  服务插件  │  可视化    │  OTA升级    │
└─────────────────────────────────────────────────────────────────┘
         │                  │             │               │
         ▼                  ▼             ▼               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据访问层 (DAL/Query)                      │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐          │
│  │  Query  │  │   DAL   │  │ Adapter │  │  Model  │          │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘          │
└─────────────────────────────────────────────────────────────────┘
         │                  │             │               │
         ▼                  ▼             ▼               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      存储层 (Storage Layer)                      │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL  │  TimescaleDB  │  Redis  │  MQTT Broker(GMQTT)  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件说明

#### 2.2.1 后端核心服务

**1. HTTP服务 (HTTP Service)**
- 端口：9999（默认）
- 提供RESTful API接口
- 基于Gin框架
- 集成Swagger文档
- JWT认证

**2. MQTT服务 (MQTT Service)**
- 端口：1883（默认）
- 支持GMQTT和VerneMQ
- 设备数据上报接收
- 命令下发
- 支持共享订阅

**3. gRPC服务 (gRPC Service)**
- 端口：50052（默认）
- 用于时序数据库通信
- 高性能数据传输

**4. Storage服务 (存储层)**
- 数据批量处理
- 遥测数据入库
- 性能优化

**5. Uplink/Downlink数据流**
- Uplink：设备上行数据处理流
- Downlink：平台下行命令处理流
- 消息总线架构

**6. 心跳监控服务 (Heartbeat Monitor)**
- 设备在线状态监控
- Redis过期事件订阅
- 设备离线检测

**7. 诊断服务 (Diagnostics)**
- 设备故障诊断
- 异常记录
- 批量刷新机制

**8. 定时任务服务 (Cron Service)**
- 基于robfig/cron
- 数据清理任务
- 定时触发器

#### 2.2.2 前端架构

**Web前端 (Vue.js 3)**
- 技术栈：Vue 3 + Vite
- UI组件库：Element Plus等
- 状态管理：Pinia/Vuex
- 路由：Vue Router
- 多语言支持：i18n
- 响应式设计

**移动端 (Uniapp)**
- 跨平台：iOS、Android、小程序、H5
- 扫码添加设备
- 实时监控
- 远程控制
- 策略管理
- 验证码登录

## 3. 技术栈

### 3.1 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Golang | 1.23+ | 主要开发语言 |
| Gin | 1.10.0 | Web框架 |
| GORM | 1.25.7 | ORM框架 |
| Casbin | 2.82.0 | 权限管理 |
| JWT | 3.2.2 | 认证授权 |
| Redis | go-redis/v9 | 缓存、消息队列 |
| MQTT | paho.mqtt v1.4.3 | 设备通信 |
| gRPC | 1.59.0 | RPC通信 |
| Logrus | 1.9.3 | 日志管理 |
| Viper | 1.18.2 | 配置管理 |
| Swagger | swaggo | API文档 |
| Prometheus | 1.20.5 | 监控指标 |

### 3.2 数据库

**关系型数据库：**
- PostgreSQL（主数据库）
- TimescaleDB（时序数据扩展）
- 支持：TDengine、Cassandra、TDSQL-PostgreSQL、PolarDB-PostgreSQL、KingBase

**缓存数据库：**
- Redis（缓存、会话、消息队列）

**消息中间件：**
- GMQTT（高性能MQTT broker）
- VerneMQ（可选）

### 3.3 前端技术栈

**Web前端：**
- Vue.js 3
- Vite
- TypeScript
- Node.js 16.13+
- Nginx

**移动端：**
- Uni-app
- Vue.js
- 支持多端编译

## 4. 核心模块

### 4.1 设备管理模块
- 设备接入（多协议支持）
- 设备分组
- 设备配置模板
- 设备功能模板
- 物模型管理
- 网关与子设备

### 4.2 数据处理模块
- 遥测数据处理
- 属性数据管理
- 事件数据管理
- 命令下发
- 数据脚本处理

### 4.3 用户权限模块
- 多租户管理
- 用户管理
- 角色权限（Casbin）
- 页面权限控制
- 数据权限控制

### 4.4 告警管理模块
- 告警配置
- 告警历史
- 通知组管理
- 多种通知方式（短信、邮件、Webhook）

### 4.5 自动化模块
- 场景联动
- 设备触发
- 定时触发
- 场景日志

### 4.6 可视化模块
- 监控看板
- 可视化大屏
- 数据图表
- 设备地图

### 4.7 OTA升级模块
- 固件管理
- 升级任务
- 升级进度跟踪
- 升级报表

### 4.8 协议插件模块
- 协议插件管理
- 自定义协议
- Modbus RTU/TCP
- TCP协议
- GB28181（安防摄像头）

### 4.9 服务插件模块
- 第三方服务接入
- 服务配置管理

## 5. 数据流向

### 5.1 设备上行数据流

```
设备 → MQTT → MQTT Service → Uplink Bus → Processor → Storage → Database
                                    ↓
                              规则引擎/告警/自动化
```

### 5.2 平台下行命令流

```
Web/APP → HTTP API → Service → Downlink Bus → MQTT Service → MQTT → 设备
```

### 5.3 数据查询流

```
Web/APP → HTTP API → Service → Query/DAL → Database → Response
```

## 6. 部署架构

### 6.1 标准部署

```
┌──────────────────────────────────────────┐
│              Nginx(前端+反向代理)         │
│         HTTP:80 / HTTPS:443               │
└──────────────┬───────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────┐
│         后端服务 (Backend)                │
│         HTTP:9999 / gRPC:50052           │
└──────┬───────────────────────────────────┘
       │
       ├─────► PostgreSQL:5432
       ├─────► Redis:6379
       └─────► MQTT Broker:1883
```

### 6.2 Docker容器化部署

推荐使用Docker Compose进行快速部署：
- backend容器
- frontend容器
- PostgreSQL容器
- Redis容器
- MQTT容器（GMQTT/VerneMQ）

### 6.3 高可用部署

- 后端多实例部署（负载均衡）
- 数据库主从复制
- Redis哨兵/集群
- MQTT集群

## 7. 核心特性

### 7.1 插件化架构
- 设备功能模板
- 设备配置模板
- 协议接入插件
- 服务接入插件
- 看板卡片
- 可视化插件
- 依赖型插件

### 7.2 多租户支持
- 租户隔离
- 数据隔离
- 权限隔离

### 7.3 安全性
- JWT认证
- Casbin权限控制
- RSA加密
- 会话管理
- 登录失败锁定

### 7.4 可扩展性
- 微服务架构
- 消息总线设计
- 插件化扩展
- 水平扩展支持

### 7.5 高性能
- Golang并发特性
- 批量数据处理
- 缓存机制
- 连接池管理
- 异步处理

## 8. API接口

### 8.1 认证接口
- 登录/登出
- Token刷新
- 验证码登录

### 8.2 设备管理接口
- 设备CRUD
- 设备数据查询
- 设备控制
- 设备配置

### 8.3 用户管理接口
- 用户CRUD
- 角色管理
- 权限管理

### 8.4 数据接口
- 遥测数据查询
- 属性数据查询
- 事件数据查询
- 历史数据

### 8.5 其他接口
- 告警接口
- 自动化接口
- 可视化接口
- OTA升级接口

详细API文档：[API Documentation](https://apifox.com/apidoc/shared-754c3f13-b1c0-44fe-905d-c75e3210d509)

## 9. 监控与运维

### 9.1 日志管理
- 分级日志（panic/fatal/error/warn/info/debug/trace）
- 日志轮转
- 控制台/文件输出

### 9.2 性能监控
- Prometheus指标导出
- 系统资源监控
- 设备状态监控

### 9.3 诊断工具
- 设备诊断服务
- 操作日志
- 系统日志

## 10. 开发规范

### 10.1 目录结构

**后端：**
```
backend/
├── cmd/              # 命令行工具
├── configs/          # 配置文件
├── docs/            # 文档
├── initialize/      # 初始化代码
├── internal/        # 内部代码
│   ├── adapter/     # 适配器层
│   ├── api/         # API层
│   ├── app/         # 应用层
│   ├── dal/         # 数据访问层
│   ├── logic/       # 业务逻辑
│   ├── middleware/  # 中间件
│   ├── model/       # 数据模型
│   ├── processor/   # 数据处理器
│   ├── query/       # 查询层
│   ├── service/     # 服务层
│   ├── storage/     # 存储层
│   ├── uplink/      # 上行数据流
│   └── downlink/    # 下行数据流
├── mqtt/            # MQTT相关
├── pkg/             # 公共包
├── router/          # 路由
├── sql/             # SQL脚本
├── static/          # 静态文件
└── main.go          # 入口文件
```

### 10.2 分层架构

采用经典分层架构：
1. **API层**: 接口定义、参数验证
2. **Service层**: 业务逻辑处理
3. **DAL/Query层**: 数据访问
4. **Model层**: 数据模型

### 10.3 代码规范

- 遵循Go官方代码规范
- 使用gofmt格式化代码
- 接口优先设计
- 单元测试覆盖

## 11. 许可证

Apache License 2.0 - 允许商业使用、修改和再发布

## 12. 联系方式

- 官网：http://thingspanel.cn
- 演示站：http://demo.thingspanel.cn
- QQ群①：260150504（已满）
- QQ群②：371794256

---

**文档版本**: v1.0  
**最后更新**: 2025-12-01
