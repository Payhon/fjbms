# 模块一测试问题与解决方案

**日期**: 2025-12-02 09:38  
**状态**: ⚠️ 需要环境配置

---

## 🔍 发现的问题

### 1. 后端编译错误

**问题描述**:
```
undefined: query.BatteryModel
undefined: query.Dealer
undefined: query.DeviceTransfer
```

**原因**: 
- 创建了新的 Service 文件使用了 `query.BatteryModel` 等，但 GORM Gen 还没有生成对应的 query 代码

**解决方案**:
1. ✅ 已更新 `backend/cmd/gen/main.go`，添加了 BMS 相关表的生成配置
2. ⚠️ 需要先执行数据库迁移脚本 `backend/sql/13.sql`
3. ⚠️ 然后运行 `go run cmd/gen/main.go` 生成 query 代码

### 2. 数据库配置问题

**问题描述**:
```
panic: database configuration is incomplete
```

**当前配置**:
- 数据库地址: `47.92.253.145:5432` (远程服务器)
- 数据库名: `ThingsPanel`
- 用户名: `postgres`
- 密码: `postgresThingsPanel`

**问题**:
- 配置文件指向远程数据库，不是本地测试环境
- 需要确认是否有权限访问该数据库
- 需要在该数据库中执行迁移脚本

### 3. 前端依赖安装

**状态**: 正在进行中 (已运行 14 分钟)
- 命令: `npx pnpm install`
- 位置: `/Users/payhon/work2025/project/fjbms/frontend`

---

## ✅ 建议的测试步骤

### 步骤 1: 准备数据库

#### 选项 A: 使用远程数据库 (当前配置)
```bash
# 1. 确认可以连接到远程数据库
psql -h 47.92.253.145 -p 5432 -U postgres -d ThingsPanel

# 2. 执行迁移脚本
psql -h 47.92.253.145 -p 5432 -U postgres -d ThingsPanel -f backend/sql/13.sql
```

#### 选项 B: 使用本地数据库 (推荐用于开发)
```bash
# 1. 修改 backend/configs/conf-dev.yml
# 将 db.psql.host 改为 localhost 或 127.0.0.1

# 2. 创建本地数据库
createdb ThingsPanel

# 3. 执行所有迁移脚本
psql -U postgres -d ThingsPanel -f backend/sql/01.sql
psql -U postgres -d ThingsPanel -f backend/sql/02.sql
# ... 执行所有脚本
psql -U postgres -d ThingsPanel -f backend/sql/13.sql
```

### 步骤 2: 生成 GORM Query 代码

```bash
cd backend
go run cmd/gen/main.go
```

### 步骤 3: 启动后端服务

```bash
cd backend
go run main.go
```

**预期输出**:
- 服务启动成功
- 监听端口: 9999 (默认)
- 日志显示数据库连接成功

### 步骤 4: 启动前端服务

```bash
cd frontend

# 等待依赖安装完成后
npx pnpm dev
```

**预期输出**:
- 开发服务器启动
- 监听端口: 5173 (Vite 默认)
- 显示本地访问地址

### 步骤 5: 浏览器测试

访问: `http://localhost:5173`

**测试清单**:
- [ ] 登录系统
- [ ] 访问 BMS 管理菜单
- [ ] 测试经销商管理
  - [ ] 查看列表
  - [ ] 新增经销商
  - [ ] 编辑经销商
  - [ ] 删除经销商
  - [ ] 搜索功能
- [ ] 测试电池型号管理
  - [ ] 查看列表
  - [ ] 新增型号
  - [ ] 编辑型号
  - [ ] 删除型号
- [ ] 测试设备转移记录
  - [ ] 查看列表
  - [ ] 搜索功能

---

## 🐛 已知问题

### 1. 路由自动生成

**问题**: 手动添加的路由配置可能会被 `elegant-router` 覆盖

**解决方案**:
- 检查 `frontend/src/router/elegant/routes.ts` 是否自动生成了 BMS 路由
- 如果没有，可能需要运行路由生成命令 (如 `npm run gen:route`)

### 2. API 接口路径

**确认事项**:
- 后端 API 路径: `/api/v1/dealer`, `/api/v1/battery/model`, `/api/v1/device/transfer`
- 前端 API 调用路径需要匹配

### 3. 权限配置

**注意**: 新增的 API 接口需要在 Casbin 中配置权限

---

## 📝 下一步行动

1. **立即执行**:
   - [ ] 确认数据库连接配置
   - [ ] 执行数据库迁移脚本
   - [ ] 生成 GORM Query 代码
   - [ ] 重新启动后端服务

2. **等待完成**:
   - [ ] 前端依赖安装完成
   - [ ] 启动前端开发服务器

3. **测试验证**:
   - [ ] 浏览器功能测试
   - [ ] API 接口测试
   - [ ] 错误处理测试

---

**当前状态**: 等待数据库配置和依赖安装完成
**预计时间**: 10-15 分钟
