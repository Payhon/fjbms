# ThingsPanel 前端开发指导文档

## 1. Web前端 (Vue.js 3)

### 1.1 环境要求

- **Node.js**: 16.13+
- **npm/pnpm**: 推荐使用pnpm
- **浏览器**: Chrome 90+, Firefox 88+, Safari 14+

### 1.2 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue.js | 3.x | 前端框架 |
| Vite | 最新 | 构建工具 |
| TypeScript | 4.x+ | 类型系统 |
| Pinia/Vuex | 最新 | 状态管理 |
| Vue Router | 4.x | 路由管理 |
| Element Plus | 最新 | UI组件库 |
| Axios | 最新 | HTTP客户端 |
| i18n | 最新 | 国际化 |

### 1.3 项目结构

```
frontend/
├── build/                # 构建配置
├── public/              # 静态资源
├── src/                 # 源代码
│   ├── assets/         # 资源文件（图片、样式等）
│   ├── components/     # 通用组件
│   ├── views/          # 页面组件
│   ├── router/         # 路由配置
│   ├── store/          # 状态管理
│   ├── api/            # API接口
│   ├── utils/          # 工具函数
│   ├── hooks/          # 组合式API
│   ├── directives/     # 自定义指令
│   ├── plugins/        # 插件
│   ├── types/          # TypeScript类型定义
│   ├── App.vue         # 根组件
│   └── main.ts         # 入口文件
├── .env                # 环境变量
├── .env.development    # 开发环境变量
├── .env.production     # 生产环境变量
├── vite.config.ts      # Vite配置
├── tsconfig.json       # TypeScript配置
├── package.json        # 依赖配置
└── README.md           # 说明文档
```

### 1.4 快速开始

#### 1.4.1 安装依赖

```bash
cd frontend

# 使用pnpm（推荐）
pnpm install

# 或使用npm
npm install
```

#### 1.4.2 配置环境变量

编辑 `.env.development`:
```env
# API地址
VITE_API_BASE_URL=http://localhost:9999

# WebSocket地址
VITE_WS_URL=ws://localhost:9999/ws

# 其他配置
VITE_APP_TITLE=ThingsPanel
```

#### 1.4.3 启动开发服务器

```bash
# 开发模式
pnpm dev

# 或
npm run dev
```

访问 `http://localhost:5173` 或配置的端口

#### 1.4.4 构建生产版本

```bash
# 构建
pnpm build

# 或
npm run build
```

构建产物在 `dist/` 目录

### 1.5 核心模块

#### 1.5.1 路由配置 (router/)

```typescript
// router/index.ts
import { createRouter, createWebHistory } from 'vue-router'
import type { RouteRecordRaw } from 'vue-router'

const routes: RouteRecordRaw[] = [
  {
    path: '/',
    redirect: '/dashboard'
  },
  {
    path: '/dashboard',
    name: 'Dashboard',
    component: () => import('@/views/Dashboard.vue'),
    meta: {
      title: '仪表板',
      requiresAuth: true
    }
  },
  {
    path: '/devices',
    name: 'Devices',
    component: () => import('@/views/Devices/Index.vue'),
    meta: {
      title: '设备管理',
      requiresAuth: true
    }
  }
  // ... 更多路由
]

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes
})

// 路由守卫
router.beforeEach((to, from, next) => {
  // 权限验证
  if (to.meta.requiresAuth) {
    const token = localStorage.getItem('token')
    if (!token) {
      next('/login')
      return
    }
  }
  next()
})

export default router
```

#### 1.5.2 状态管理 (store/)

使用Pinia:

```typescript
// store/user.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import type { User } from '@/types'

export const useUserStore = defineStore('user', () => {
  // State
  const user = ref<User | null>(null)
  const token = ref<string>('')

  // Getters
  const isLoggedIn = computed(() => !!token.value)
  const userInfo = computed(() => user.value)

  // Actions
  function setUser(userData: User) {
    user.value = userData
  }

  function setToken(tokenValue: string) {
    token.value = tokenValue
    localStorage.setItem('token', tokenValue)
  }

  function logout() {
    user.value = null
    token.value = ''
    localStorage.removeItem('token')
  }

  // 初始化
  function init() {
    const savedToken = localStorage.getItem('token')
    if (savedToken) {
      token.value = savedToken
    }
  }

  return {
    user,
    token,
    isLoggedIn,
    userInfo,
    setUser,
    setToken,
    logout,
    init
  }
})
```

#### 1.5.3 API封装 (api/)

```typescript
// api/request.ts
import axios from 'axios'
import type { AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios'
import { ElMessage } from 'element-plus'
import { useUserStore } from '@/store/user'

// 创建axios实例
const service: AxiosInstance = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 15000
})

// 请求拦截器
service.interceptors.request.use(
  (config) => {
    const userStore = useUserStore()
    if (userStore.token) {
      config.headers['x-token'] = userStore.token
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器
service.interceptors.response.use(
  (response: AxiosResponse) => {
    const res = response.data
    
    // 根据业务状态码处理
    if (res.code !== 200) {
      ElMessage.error(res.message || '请求失败')
      
      // Token过期
      if (res.code === 401) {
        const userStore = useUserStore()
        userStore.logout()
        window.location.href = '/login'
      }
      
      return Promise.reject(new Error(res.message || '请求失败'))
    }
    
    return res.data
  },
  (error) => {
    ElMessage.error(error.message || '网络错误')
    return Promise.reject(error)
  }
)

export default service

// api/device.ts
import request from './request'
import type { Device, DeviceListParams } from '@/types/device'

export const deviceApi = {
  // 获取设备列表
  getList(params: DeviceListParams) {
    return request({
      url: '/api/v1/device/list',
      method: 'get',
      params
    })
  },

  // 获取设备详情
  getDetail(id: string) {
    return request({
      url: `/api/v1/device/${id}`,
      method: 'get'
    })
  },

  // 创建设备
  create(data: Partial<Device>) {
    return request({
      url: '/api/v1/device',
      method: 'post',
      data
    })
  },

  // 更新设备
  update(id: string, data: Partial<Device>) {
    return request({
      url: `/api/v1/device/${id}`,
      method: 'put',
      data
    })
  },

  // 删除设备
  delete(id: string) {
    return request({
      url: `/api/v1/device/${id}`,
      method: 'delete'
    })
  },

  // 控制设备
  control(deviceId: string, command: any) {
    return request({
      url: `/api/v1/device/${deviceId}/control`,
      method: 'post',
      data: command
    })
  }
}
```

#### 1.5.4 组件开发

```vue
<!-- components/DeviceCard.vue -->
<template>
  <el-card class="device-card" shadow="hover">
    <template #header>
      <div class="card-header">
        <span>{{ device.name }}</span>
        <el-tag :type="statusType">{{ statusText }}</el-tag>
      </div>
    </template>
    
    <div class="device-info">
      <div class="info-item">
        <span class="label">设备编号:</span>
        <span class="value">{{ device.device_number }}</span>
      </div>
      <div class="info-item">
        <span class="label">设备类型:</span>
        <span class="value">{{ device.device_type }}</span>
      </div>
      <div class="info-item">
        <span class="label">位置:</span>
        <span class="value">{{ device.location || '-' }}</span>
      </div>
    </div>

    <template #footer>
      <el-button type="primary" size="small" @click="handleView">
        查看详情
      </el-button>
      <el-button size="small" @click="handleControl">
        设备控制
      </el-button>
    </template>
  </el-card>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import type { Device } from '@/types/device'

interface Props {
  device: Device
}

const props = defineProps<Props>()
const emit = defineEmits<{
  view: [device: Device]
  control: [device: Device]
}>()

const statusType = computed(() => {
  return props.device.is_online ? 'success' : 'info'
})

const statusText = computed(() => {
  return props.device.is_online ? '在线' : '离线'
})

const handleView = () => {
  emit('view', props.device)
}

const handleControl = () => {
  emit('control', props.device)
}
</script>

<style scoped lang="scss">
.device-card {
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .device-info {
    .info-item {
      display: flex;
      margin-bottom: 8px;

      .label {
        color: #666;
        margin-right: 8px;
      }

      .value {
        flex: 1;
        color: #333;
      }
    }
  }
}
</style>
```

#### 1.5.5 Hooks使用

```typescript
// hooks/useDeviceData.ts
import { ref, onMounted, onUnmounted } from 'vue'
import { deviceApi } from '@/api/device'
import type { Device } from '@/types/device'

export function useDeviceData(deviceId: string) {
  const device = ref<Device | null>(null)
  const loading = ref(false)
  const error = ref<Error | null>(null)
  let timer: number | null = null

  // 获取设备数据
  const fetchData = async () => {
    loading.value = true
    try {
      device.value = await deviceApi.getDetail(deviceId)
      error.value = null
    } catch (e) {
      error.value = e as Error
    } finally {
      loading.value = false
    }
  }

  // 启动轮询
  const startPolling = (interval = 5000) => {
    fetchData()
    timer = setInterval(fetchData, interval)
  }

  // 停止轮询
  const stopPolling = () => {
    if (timer) {
      clearInterval(timer)
      timer = null
    }
  }

  onMounted(() => {
    startPolling()
  })

  onUnmounted(() => {
    stopPolling()
  })

  return {
    device,
    loading,
    error,
    fetchData,
    startPolling,
    stopPolling
  }
}
```

### 1.6 样式规范

#### 1.6.1 使用SCSS

```scss
// styles/variables.scss
// 颜色
$primary-color: #409EFF;
$success-color: #67C23A;
$warning-color: #E6A23C;
$danger-color: #F56C6C;
$info-color: #909399;

// 尺寸
$border-radius: 4px;
$box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);

// 字体
$font-size-base: 14px;
$font-size-small: 12px;
$font-size-large: 16px;
```

#### 1.6.2 BEM命名规范

```scss
.device-list {
  // Block
  padding: 20px;

  &__header {
    // Element
    display: flex;
    justify-content: space-between;
  }

  &__item {
    // Element
    margin-bottom: 16px;

    &--active {
      // Modifier
      background-color: #f0f0f0;
    }
  }
}
```

### 1.7 TypeScript类型定义

```typescript
// types/device.ts
export interface Device {
  id: string
  name: string
  device_number: string
  device_config_id: string
  product_id: string
  tenant_id: string
  is_online: number
  is_enabled: string
  activate_flag: string
  location?: string
  protocol: string
  additional_info?: Record<string, any>
  created_at: string
  update_at: string
}

export interface DeviceListParams {
  page: number
  page_size: number
  name?: string
  is_online?: number
  group_id?: string
}

export interface DeviceListResponse {
  list: Device[]
  total: number
  page: number
  page_size: number
}

// types/api.ts
export interface ApiResponse<T = any> {
  code: number
  message: string
  data: T
}
```

### 1.8 WebSocket使用

```typescript
// utils/websocket.ts
export class WebSocketClient {
  private ws: WebSocket | null = null
  private url: string
  private reconnectTimer: number | null = null
  private heartbeatTimer: number | null = null

  constructor(url: string) {
    this.url = url
  }

  connect() {
    this.ws = new WebSocket(this.url)

    this.ws.onopen = () => {
      console.log('WebSocket connected')
      this.startHeartbeat()
    }

    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data)
      this.handleMessage(data)
    }

    this.ws.onerror = (error) => {
      console.error('WebSocket error:', error)
    }

    this.ws.onclose = () => {
      console.log('WebSocket closed')
      this.stopHeartbeat()
      this.reconnect()
    }
  }

  send(data: any) {
    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(data))
    }
  }

  private handleMessage(data: any) {
    // 处理消息
    console.log('Received:', data)
  }

  private startHeartbeat() {
    this.heartbeatTimer = setInterval(() => {
      this.send({ type: 'ping' })
    }, 30000)
  }

  private stopHeartbeat() {
    if (this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer)
      this.heartbeatTimer = null
    }
  }

  private reconnect() {
    this.reconnectTimer = setTimeout(() => {
      console.log('Reconnecting...')
      this.connect()
    }, 5000)
  }

  disconnect() {
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer)
    }
    this.stopHeartbeat()
    if (this.ws) {
      this.ws.close()
      this.ws = null
    }
  }
}
```

### 1.9 部署

#### 1.9.1 Nginx配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    root /var/www/thingspanel/frontend;
    index index.html;

    # Gzip压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api {
        proxy_pass http://localhost:9999;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # WebSocket代理
    location /ws {
        proxy_pass http://localhost:9999;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## 2. 移动端 (Uniapp)

### 2.1 环境要求

- **HBuilderX**: 最新版本
- **Node.js**: 16.13+
- **微信开发者工具**: 小程序开发需要
- **Android Studio**: Android开发需要
- **Xcode**: iOS开发需要（仅Mac）

### 2.2 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Uni-app | 最新 | 跨平台开发框架 |
| Vue.js | 2.x/3.x | 前端框架 |
| uView UI | 2.x | UI组件库 |
| Vuex | 最新 | 状态管理 |

### 2.3 项目结构

```
fjbms-uniapp/
├── API/                # API接口
├── common/            # 公共资源
│   ├── config.js     # 配置文件
│   ├── utils.js      # 工具函数
│   └── request.js    # 请求封装
├── components/        # 组件
├── lang/             # 多语言
├── pages/            # 页面
│   ├── index/       # 首页
│   ├── device/      # 设备相关
│   ├── control/     # 控制页面
│   ├── user/        # 用户相关
│   └── ...
├── plugins/          # 插件
├── service/          # 服务
├── static/           # 静态资源
├── store/            # 状态管理
├── uni_modules/      # uni模块
├── App.vue           # 根组件
├── main.js           # 入口文件
├── manifest.json     # 应用配置
└── pages.json        # 页面配置
```

### 2.4 快速开始

#### 2.4.1 使用HBuilderX

1. 打开HBuilderX
2. 导入项目：文件 → 导入 → 从本地目录导入
3. 选择 `fjbms-uniapp` 目录
4. 运行：运行 → 运行到内置浏览器/小程序/真机

#### 2.4.2 使用CLI

```bash
cd fjbms-uniapp

# 安装依赖
pnpm install

# H5开发
pnpm dev:h5

# 微信小程序开发
pnpm dev:mp-weixin

# App开发
pnpm dev:app
```

### 2.5 核心配置

#### 2.5.1 manifest.json

```json
{
  "name": "ThingsPanel",
  "appid": "__UNI__XXXXXXX",
  "description": "物联网管理平台",
  "versionName": "1.0.0",
  "versionCode": "100",
  "app-plus": {
    "modules": {
      "Camera": {},
      "Barcode": {}
    },
    "distribute": {
      "android": {
        "permissions": [
          "<uses-permission android:name=\"android.permission.CAMERA\"/>",
          "<uses-permission android:name=\"android.permission.INTERNET\"/>"
        ]
      },
      "ios": {
        "capabilities": {
          "entitlements": {}
        }
      }
    }
  },
  "mp-weixin": {
    "appid": "wxxxxxxxxxxx",
    "setting": {
      "urlCheck": false
    }
  }
}
```

#### 2.5.2 pages.json

```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationBarTitleText": "首页"
      }
    },
    {
      "path": "pages/device/list",
      "style": {
        "navigationBarTitleText": "设备列表"
      }
    },
    {
      "path": "pages/device/detail",
      "style": {
        "navigationBarTitleText": "设备详情"
      }
    }
  ],
  "tabBar": {
    "color": "#7A7E83",
    "selectedColor": "#3cc51f",
    "borderStyle": "black",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/index/index",
        "iconPath": "static/tabbar/home.png",
        "selectedIconPath": "static/tabbar/home-active.png",
        "text": "首页"
      },
      {
        "pagePath": "pages/device/list",
        "iconPath": "static/tabbar/device.png",
        "selectedIconPath": "static/tabbar/device-active.png",
        "text": "设备"
      },
      {
        "pagePath": "pages/user/index",
        "iconPath": "static/tabbar/user.png",
        "selectedIconPath": "static/tabbar/user-active.png",
        "text": "我的"
      }
    ]
  },
  "globalStyle": {
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "ThingsPanel",
    "navigationBarBackgroundColor": "#F8F8F8",
    "backgroundColor": "#F8F8F8"
  }
}
```

### 2.6 API封装

```javascript
// common/request.js
import store from '@/store'

const BASE_URL = process.env.NODE_ENV === 'development' 
  ? 'http://localhost:9999' 
  : 'https://api.yourdomain.com'

export function request(options) {
  return new Promise((resolve, reject) => {
    uni.request({
      url: BASE_URL + options.url,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'x-token': store.state.token || ''
      },
      success: (res) => {
        if (res.statusCode === 200) {
          if (res.data.code === 200) {
            resolve(res.data.data)
          } else {
            uni.showToast({
              title: res.data.message || '请求失败',
              icon: 'none'
            })
            reject(res.data)
          }
        } else {
          reject(res)
        }
      },
      fail: (err) => {
        uni.showToast({
          title: '网络错误',
          icon: 'none'
        })
        reject(err)
      }
    })
  })
}

// API/device.js
import { request } from '@/common/request'

export const deviceApi = {
  // 获取设备列表
  getList(params) {
    return request({
      url: '/api/v1/device/list',
      method: 'GET',
      data: params
    })
  },

  // 设备控制
  control(deviceId, data) {
    return request({
      url: `/api/v1/device/${deviceId}/control`,
      method: 'POST',
      data
    })
  }
}
```

### 2.7 页面开发

```vue
<!-- pages/device/list.vue -->
<template>
  <view class="device-list">
    <!-- 搜索栏 -->
    <view class="search-bar">
      <uni-search-bar 
        v-model="searchText" 
        @confirm="handleSearch"
        placeholder="搜索设备"
      />
    </view>

    <!-- 设备列表 -->
    <scroll-view 
      scroll-y 
      class="list-container"
      @scrolltolower="handleLoadMore"
    >
      <view 
        v-for="device in deviceList" 
        :key="device.id"
        class="device-item"
        @click="handleDeviceClick(device)"
      >
        <view class="device-header">
          <text class="device-name">{{ device.name }}</text>
          <uni-tag 
            :text="device.is_online ? '在线' : '离线'" 
            :type="device.is_online ? 'success' : 'default'"
          />
        </view>
        <view class="device-info">
          <text class="info-text">编号: {{ device.device_number }}</text>
          <text class="info-text">位置: {{ device.location || '-' }}</text>
        </view>
      </view>
    </scroll-view>

    <!-- 空状态 -->
    <uni-empty 
      v-if="!deviceList.length && !loading"
      mode="data"
      text="暂无设备"
    />

    <!-- 加载中 -->
    <uni-load-more 
      v-if="loading"
      status="loading"
    />
  </view>
</template>

<script>
import { deviceApi } from '@/API/device'

export default {
  data() {
    return {
      searchText: '',
      deviceList: [],
      loading: false,
      page: 1,
      pageSize: 20,
      total: 0
    }
  },

  onLoad() {
    this.loadDeviceList()
  },

  onPullDownRefresh() {
    this.page = 1
    this.deviceList = []
    this.loadDeviceList().then(() => {
      uni.stopPullDownRefresh()
    })
  },

  methods: {
    async loadDeviceList() {
      if (this.loading) return

      this.loading = true
      try {
        const res = await deviceApi.getList({
          page: this.page,
          page_size: this.pageSize,
          name: this.searchText
        })

        this.deviceList = this.page === 1 
          ? res.list 
          : [...this.deviceList, ...res.list]
        this.total = res.total
      } catch (error) {
        console.error('加载设备列表失败:', error)
      } finally {
        this.loading = false
      }
    },

    handleSearch() {
      this.page = 1
      this.deviceList = []
      this.loadDeviceList()
    },

    handleLoadMore() {
      if (this.deviceList.length >= this.total) return
      this.page++
      this.loadDeviceList()
    },

    handleDeviceClick(device) {
      uni.navigateTo({
        url: '/pages/device/detail?id=' + device.id
      })
    }
  }
}
</script>

<style lang="scss" scoped>
.device-list {
  height: 100vh;
  display: flex;
  flex-direction: column;

  .search-bar {
    padding: 20rpx;
    background-color: #fff;
  }

  .list-container {
    flex: 1;
    padding: 20rpx;
  }

  .device-item {
    background-color: #fff;
    border-radius: 16rpx;
    padding: 24rpx;
    margin-bottom: 20rpx;

    .device-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16rpx;

      .device-name {
        font-size: 32rpx;
        font-weight: 500;
      }
    }

    .device-info {
      .info-text {
        display: block;
        font-size: 28rpx;
        color: #666;
        margin-bottom: 8rpx;
      }
    }
  }
}
</style>
```

### 2.8 扫码功能

```javascript
// common/utils.js
export function scanQRCode() {
  return new Promise((resolve, reject) => {
    uni.scanCode({
      success: (res) => {
        resolve(res.result)
      },
      fail: (err) => {
        reject(err)
      }
    })
  })
}

// 使用
import { scanQRCode } from '@/common/utils'

async handleScan() {
  try {
    const result = await scanQRCode()
    // 处理扫码结果
    console.log('扫码结果:', result)
  } catch (error) {
    uni.showToast({
      title: '扫码失败',
      icon: 'none'
    })
  }
}
```

### 2.9 打包发布

#### 2.9.1 H5打包

```bash
pnpm build:h5
```

#### 2.9.2 微信小程序打包

1. HBuilderX: 发行 → 小程序-微信
2. 上传到微信公众平台

#### 2.9.3 App打包

1. HBuilderX: 发行 → 原生App-云打包
2. 配置证书和签名
3. 提交打包

#### 2.9.4 App离线打包

参考官方文档进行离线打包配置

---

**文档版本**: v1.0  
**最后更新**: 2025-12-01
