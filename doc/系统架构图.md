# ThingsPanel 系统架构图

## 1. 整体系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          客户端层 (Client Layer)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │  Web浏览器   │  │ 移动端APP    │  │  第三方API   │  │  设备SDK   │ │
│  │  (Vue.js 3)  │  │  (Uni-app)   │  │              │  │            │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └─────┬──────┘ │
│         │                 │                 │                │        │
└─────────┼─────────────────┼─────────────────┼────────────────┼────────┘
          │                 │                 │                │
          ▼                 ▼                 ▼                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        网关层 (Gateway Layer)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                       Nginx (负载均衡 + 反向代理)                        │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  │
│  │   HTTP/S    │  │  WebSocket  │  │   gRPC      │  │   MQTT       │  │
│  │   :80/443   │  │   :9999     │  │   :50052    │  │   :1883      │  │
│  └─────┬───────┘  └─────┬───────┘  └─────┬───────┘  └──────┬───────┘  │
└────────┼────────────────┼─────────────────┼──────────────────┼─────────┘
         │                │                 │                  │
         ▼                ▼                 ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     应用服务层 (Application Layer)                      │
│                          ThingsPanel Backend (Go)                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                       核心服务 (Core Services)                    │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                  │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌───────────┐ │  │
│  │  │ HTTP服务   │  │ MQTT服务   │  │ gRPC服务   │  │ Cron服务  │ │  │
│  │  │ (Gin)      │  │ (Paho)     │  │            │  │ (定时任务)│ │  │
│  │  └────┬───────┘  └─────┬──────┘  └─────┬──────┘  └─────┬─────┘ │  │
│  │       │                │               │               │       │  │
│  │       └────────────────┴───────┬───────┴───────────────┘       │  │
│  │                                │                               │  │
│  └────────────────────────────────┼───────────────────────────────┘  │
│                                   │                                  │
│  ┌────────────────────────────────┼───────────────────────────────┐  │
│  │               消息流处理 (Message Flow)                        │  │
│  ├────────────────────────────────┼───────────────────────────────┤  │
│  │                                │                               │  │
│  │  ┌──────────────────────────────────────────────────────────┐ │  │
│  │  │                   Uplink Bus (上行)                      │ │  │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │ │  │
│  │  │  │ Telemetry │→ │ Attribute │→ │   Event   │→ Storage  │ │  │
│  │  │  │ Processor │  │ Processor │  │ Processor │           │ │  │
│  │  │  └───────────┘  └───────────┘  └───────────┘           │ │  │
│  │  └──────────────────────────────────────────────────────────┘ │  │
│  │                                │                               │  │
│  │  ┌──────────────────────────────────────────────────────────┐ │  │
│  │  │                 Downlink Bus (下行)                      │ │  │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │ │  │
│  │  │  │  Command  │  │ Attribute │  │  Control  │           │ │  │
│  │  │  │  Sender   │  │  Setter   │  │   Logic   │           │ │  │
│  │  │  └───────────┘  └───────────┘  └───────────┘           │ │  │
│  │  └──────────────────────────────────────────────────────────┘ │  │
│  │                                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                 辅助服务 (Support Services)                   │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │                                                               │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐            │  │
│  │  │  Storage   │  │ Heartbeat  │  │Diagnostics │            │  │
│  │  │  Service   │  │  Monitor   │  │  Service   │            │  │
│  │  └────────────┘  └────────────┘  └────────────┘            │  │
│  │                                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                  业务逻辑层 (Business Logic)                  │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │                                                               │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │
│  │  │设备管理  │  │用户管理  │  │告警管理  │  │自动化    │    │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │  │
│  │                                                               │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │
│  │  │协议插件  │  │服务插件  │  │OTA升级   │  │可视化    │    │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │  │
│  │                                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                数据访问层 (Data Access Layer)                 │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │                                                               │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐            │  │
│  │  │ Query  │  │  DAL   │  │Adapter │  │ Model  │            │  │
│  │  │ (GORM) │  │        │  │        │  │        │            │  │
│  │  └────────┘  └────────┘  └────────┘  └────────┘            │  │
│  │                                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────┬───────────────────────────────────────┬───────────────┘
              │                                       │
              ▼                                       ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        存储层 (Storage Layer)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌───────────┐  │
│  │ PostgreSQL   │  │ TimescaleDB  │  │    Redis     │  │   GMQTT   │  │
│  │ (业务数据)   │  │ (时序数据)   │  │  (缓存/队列) │  │ (消息队列)│  │
│  │   :5432      │  │              │  │    :6379     │  │   :1883   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └───────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. 设备数据流向

### 2.1 设备上报数据流程

```
┌─────────────┐
│   物联网设备 │
└──────┬──────┘
       │ MQTT Publish
       │ Topic: devices/telemetry
       ▼
┌──────────────────────┐
│   MQTT Broker        │
│   (GMQTT/VerneMQ)    │
└──────┬───────────────┘
       │ Subscribe
       ▼
┌──────────────────────┐
│   MQTT Service       │
│   消息接收与解析     │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│   Uplink Bus         │
│   (消息总线)         │
└──────┬───────────────┘
       │
       ├─────────────────────────────────┐
       │                                 │
       ▼                                 ▼
┌──────────────────┐            ┌──────────────────┐
│  Data Processor  │            │  Rule Engine     │
│  数据处理器      │            │  规则引擎        │
│                  │            │                  │
│  • 数据校验      │            │  • 场景联动      │
│  • 脚本处理      │            │  • 告警触发      │
│  • 数据转换      │            │  • 自动化        │
└────┬─────────────┘            └──────────────────┘
     │
     ▼
┌──────────────────┐
│  Storage Service │
│  存储服务        │
│                  │
│  • 批量处理      │
│  • 性能优化      │
└────┬─────────────┘
     │
     ├──────────────┬────────────────┐
     │              │                │
     ▼              ▼                ▼
┌─────────┐  ┌─────────────┐  ┌──────────┐
│ Current │  │  Historical │  │  Redis   │
│  Table  │  │    Table    │  │  Cache   │
│         │  │             │  │          │
│ 当前值  │  │ 时序数据    │  │ 实时缓存 │
└─────────┘  └─────────────┘  └──────────┘
             (TimescaleDB)
```

### 2.2 设备控制命令流程

```
┌─────────────┐
│  Web/App    │
│  客户端     │
└──────┬──────┘
       │ HTTP POST
       │ /api/v1/device/:id/control
       ▼
┌──────────────────────┐
│   API Handler        │
│   权限验证           │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│   Service Layer      │
│   业务逻辑处理       │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│   Downlink Bus       │
│   (下行消息总线)     │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│   MQTT Service       │
│   命令下发           │
└──────┬───────────────┘
       │ MQTT Publish
       │ Topic: devices/command/:device_id
       ▼
┌──────────────────────┐
│   MQTT Broker        │
└──────┬───────────────┘
       │ Subscribe
       ▼
┌─────────────┐
│  物联网设备  │
│  执行命令    │
└──────┬──────┘
       │ Response
       │ Topic: devices/command/response
       ▼
┌──────────────────────┐
│   MQTT Service       │
│   接收响应           │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│   Command Log        │
│   记录执行日志       │
└──────────────────────┘
```

## 3. 分层架构详解

### 3.1 展示层 (Presentation Layer)

```
┌──────────────────────────────────────────┐
│          Web Frontend (Vue 3)            │
├──────────────────────────────────────────┤
│                                          │
│  ┌────────────┐  ┌────────────┐         │
│  │   Views    │  │ Components │         │
│  │  (页面)    │  │  (组件)    │         │
│  └────────────┘  └────────────┘         │
│                                          │
│  ┌────────────┐  ┌────────────┐         │
│  │   Router   │  │   Store    │         │
│  │  (路由)    │  │  (状态)    │         │
│  └────────────┘  └────────────┘         │
│                                          │
│  ┌────────────────────────────┐         │
│  │        API Layer           │         │
│  │      (Axios封装)           │         │
│  └────────────────────────────┘         │
│                                          │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│        Mobile App (Uni-app)              │
├──────────────────────────────────────────┤
│                                          │
│  ┌────────────┐  ┌────────────┐         │
│  │   Pages    │  │ Components │         │
│  └────────────┘  └────────────┘         │
│                                          │
│  ┌────────────┐  ┌────────────┐         │
│  │   Vuex     │  │    API     │         │
│  └────────────┘  └────────────┘         │
│                                          │
└──────────────────────────────────────────┘
```

### 3.2 业务逻辑层 (Business Logic Layer)

```
┌──────────────────────────────────────────┐
│            Service Layer                 │
├──────────────────────────────────────────┤
│                                          │
│  ┌──────────────────┐                   │
│  │  Device Service  │                   │
│  │  • 设备CRUD      │                   │
│  │  • 设备控制      │                   │
│  │  • 状态管理      │                   │
│  └──────────────────┘                   │
│                                          │
│  ┌──────────────────┐                   │
│  │   Data Service   │                   │
│  │  • 数据查询      │                   │
│  │  • 数据聚合      │                   │
│  │  • 数据导出      │                   │
│  └──────────────────┘                   │
│                                          │
│  ┌──────────────────┐                   │
│  │   Alarm Service  │                   │
│  │  • 告警配置      │                   │
│  │  • 告警触发      │                   │
│  │  • 通知发送      │                   │
│  └──────────────────┘                   │
│                                          │
│  ┌──────────────────┐                   │
│  │   Auto Service   │                   │
│  │  • 场景联动      │                   │
│  │  • 定时任务      │                   │
│  │  • 动作执行      │                   │
│  └──────────────────┘                   │
│                                          │
└──────────────────────────────────────────┘
```

### 3.3 数据访问层 (Data Access Layer)

```
┌──────────────────────────────────────────┐
│          Data Access Layer               │
├──────────────────────────────────────────┤
│                                          │
│  ┌──────────────────┐                   │
│  │  Query (GORM)    │ ← 类型安全查询    │
│  │  • 生成的代码    │                   │
│  │  • 链式调用      │                   │
│  └──────────────────┘                   │
│                                          │
│  ┌──────────────────┐                   │
│  │   DAL Layer      │ ← 数据访问抽象    │
│  │  • CRUD操作      │                   │
│  │  • 事务管理      │                   │
│  └──────────────────┘                   │
│                                          │
│  ┌──────────────────┐                   │
│  │   Model Layer    │ ← 数据模型定义    │
│  │  • 表结构        │                   │
│  │  • 关系定义      │                   │
│  └──────────────────┘                   │
│                                          │
└──────────────────────────────────────────┘
```

## 4. 部署架构

### 4.1 单机部署

```
┌────────────────────────────────────────────┐
│           服务器 (Single Server)           │
├────────────────────────────────────────────┤
│                                            │
│  ┌──────────────────────────────────────┐ │
│  │            Nginx (:80/443)            │ │
│  │    • 静态文件                         │ │
│  │    • 反向代理                         │ │
│  └─────────────┬────────────────────────┘ │
│                │                           │
│  ┌─────────────▼────────────────────────┐ │
│  │     ThingsPanel Backend (:9999)      │ │
│  │    • HTTP/WebSocket/gRPC             │ │
│  └──────────────────────────────────────┘ │
│                                            │
│  ┌──────────────┐  ┌──────────────────┐  │
│  │ PostgreSQL   │  │ TimescaleDB      │  │
│  │   (:5432)    │  │ (PostgreSQL插件) │  │
│  └──────────────┘  └──────────────────┘  │
│                                            │
│  ┌──────────────┐  ┌──────────────────┐  │
│  │    Redis     │  │      GMQTT       │  │
│  │   (:6379)    │  │     (:1883)      │  │
│  └──────────────┘  └──────────────────┘  │
│                                            │
└────────────────────────────────────────────┘
```

### 4.2 分布式部署

```
┌───────────────────────────────────────────────────────────┐
│                      Load Balancer                        │
│                    (Nginx/HAProxy)                        │
└────────┬───────────────────────┬──────────────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│  Backend Node 1 │     │  Backend Node 2 │
│  • HTTP Service │     │  • HTTP Service │
│  • MQTT Service │     │  • MQTT Service │
│  • gRPC Service │     │  • gRPC Service │
└────────┬────────┘     └────────┬────────┘
         │                       │
         └───────────┬───────────┘
                     │
         ┌───────────┴───────────┬──────────────┐
         │                       │              │
         ▼                       ▼              ▼
┌─────────────────┐   ┌──────────────┐  ┌────────────┐
│  PostgreSQL     │   │    Redis     │  │   GMQTT    │
│  (Master-Slave) │   │   (Cluster)  │  │ (Cluster)  │
│                 │   │              │  │            │
│  • Master       │   │  • Node 1    │  │  • Broker1 │
│  • Slave 1      │   │  • Node 2    │  │  • Broker2 │
│  • Slave 2      │   │  • Node 3    │  │  • Broker3 │
└─────────────────┘   └──────────────┘  └────────────┘
```

## 5. 监控架构

```
┌─────────────────────────────────────────────────────────┐
│                    监控层 (Monitoring)                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │
│  │ Prometheus   │  │   Grafana    │  │   Alert     │  │
│  │ (指标采集)   │→ │  (可视化)    │→ │  (告警)     │  │
│  └──────┬───────┘  └──────────────┘  └─────────────┘  │
│         │                                              │
└─────────┼──────────────────────────────────────────────┘
          │
          ▼ (Metrics Export)
┌─────────────────────────────────────────────────────────┐
│               应用层 (Application)                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────────────────────────────┐          │
│  │      ThingsPanel Backend                 │          │
│  │  • HTTP指标                              │          │
│  │  • 业务指标                              │          │
│  │  • 性能指标                              │          │
│  └──────────────────────────────────────────┘          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

**文档版本**: v1.0  
**最后更新**: 2025-12-01
