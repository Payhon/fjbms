## 开发计划（可执行版）

### 0. 文档信息
- **项目**：FJBMS（ThingsPanel 二次开发：BMS 系统）
- **范围来源**：`doc/二次开发需求文档.md`
- **进度依据**：`doc/开发进度.md`、`doc/模块一完成报告.md`、`doc/模块二完成报告.md`、`doc/模块一前端完成报告.md`
- **更新时间**：2025-12-12
- **目标**：以“厂家-经销商-终端用户”链路为主线，形成可验收的业务闭环：出厂入库→分配/转移→激活→监控/告警→维保→OTA。

---

## 1. 当前开发进度（已完成）

### 1.1 后端（已完成）
- **经销商管理**：CRUD、列表/详情、删除校验
- **电池型号管理**：CRUD、列表/详情、删除校验
- **设备转移**：批量转移、转移记录查询
- **设备绑定（APP 激活接口）**：绑定/解绑/用户设备列表（含激活状态与流转状态更新）
- **维保管理**：创建/列表/详情/状态更新（含图片与处理结果 JSON）
- **BMS 路由挂载与数据权限中间件**：`DealerAuthMiddleware`（向下的数据范围控制基础已具备）

### 1.2 Web 管理端（已完成）
- **BMS 菜单与路由**：`/bms/*`
- **页面**：经销商管理、电池型号管理、设备转移记录、维保中心
- **API 封装**：`frontend/src/service/api/bms.ts`（覆盖上述模块）

---

## 2. 需求覆盖矩阵（按需求文档章节）
> 用于验收追踪：每条需求要能落到“页面/接口/数据表/验收用例”。

### 2.1 WEB 端需求
- **2.1.1 首页面板**：未开始（Dashboard 指标/地图/告警概览/趋势/快捷入口）
- **2.1.2 电池管理**：部分完成（已完成：电池列表查询/导出、导入模板+导入、批量分配经销商、电池型号、转移记录、标签管理+批量打标、离线指令、批量下发指令、批量 OTA 推送；未完成：OTA 列表管理（任务/详情独立页）/参数远程查看修改）
- **2.1.3 维保管理**：部分完成（已完成：用户维保基础流程；未完成：电池维保记录、激活日志、退换货）
- **2.1.4 经销商管理**：部分完成（已完成：经销商列表；未完成：经销商数据穿透、终端用户、授权管理）
- **2.1.5 运营管理**：未开始（操作记录页面/检索）
- **2.1.6 系统管理**：部分完成（已完成：BMS 账号管理/角色管理入口与基础能力；待补：更精细的按钮级权限与角色预设）
- **2.1.7 定制服务**：未开始（激活记录统计、出厂记录）

### 2.2 APP 端需求
- **2.2.1 登录/注册/找回**：未开始
- **2.2.2 电池列表（扫码添加/解绑/重命名/状态筛选）**：未开始（但后端绑定接口已完成）
- **2.2.3 电池控制面板（仪表盘/电芯/OTA）**：未开始
- **2.2.4 告警**：未开始
- **2.2.5 参数设置**：未开始
- **2.2.6 我的**：未开始

---

## 3. 里程碑与交付标准

### 3.1 里程碑定义
- **M1（Web 生命周期闭环）**：电池导入/分配/查询/转移/导出可用，数据隔离正确。
- **M2（运营可视化 + 经销商体系完善）**：Dashboard 可用；终端用户管理与授权可用；告警概览可用。
- **M3（售后可追溯）**：激活日志、退换货、操作日志可用；维保流程可审计。
- **M4（OTA 可批量）**：OTA 包/任务/批量推送/进度与结果可追踪。
- **M5（APP 基础可用）**：登录与扫码绑定/设备列表/基础状态展示可用。
- **M6（APP 完整体验）**：控制面板、告警、维保提交、OTA、参数设置（含 BLE/MQTT 双模策略）可用。

### 3.2 通用验收标准（每个迭代都必须满足）
- **可运行**：前后端启动稳定，关键接口可通过接口集合回归。
- **可追踪**：每个功能点有对应页面/接口/表结构与验收用例。
- **权限正确**：厂家与经销商数据隔离、终端用户仅见自身。
- **回归通过**：新增功能提供最小回归清单（接口+关键 UI 流程）。

---

## 4. 迭代计划（建议 6 周 + 并行 APP）
> 说明：若团队人力不足，可按优先级顺延；若人力充足，Web 与 APP 可并行推进。

### 迭代 0：联调与工程化兜底（1–3 天）
- **目标**：把“能跑、能联调、能验收”的地基夯实。
- **任务清单**：
  - [ ] 后端服务端口与健康检查稳定（补齐/确认 `health`/Swagger）
  - [ ] 统一接口集合（Apifox/Postman）覆盖：dealer/model/transfer/bind/warranty
  - [ ] Web 端 BMS 已完成页面联调回归（CRUD/筛选/分页/弹窗）
  - [ ] 明确角色与账号准备方案：厂家管理员/经销商管理员/终端用户（最小数据集）
- **交付物**：接口集合、回归清单、联调环境说明（不新增文档可写在本文件“附录”）
- **验收用例**：模块一/二完成报告中的验证清单全部可执行。
- **风险/依赖**：后端进程未监听端口将阻塞所有联调（优先解决）。

### 迭代 1：Web「电池管理-电池列表」一期（1 周）——对齐 2.1.2.1
- **范围**：
  - [x] 电池列表：多条件查询（序列号/型号/在线/激活/经销商/出厂日期/质保状态）
  - [x] 列表字段：序列号、型号、出厂日期、经销商、终端用户、激活时间、在线、SOC/SOH、质保到期日、固件版本
  - [x] 导出：按当前筛选结果导出 Excel
  - [x] 详情入口：跳转设备详情（先复用现有设备详情或提供 BMS 详情页壳）
  - [x] 厂家/经销商视角：经销商只能看到名下设备
- **非本期（明确不做）**：批量下发指令、参数远程修改、离线指令、批量 OTA 推送。
- **需要补齐/新增后端能力（可能项）**：
  - [x] 电池列表查询 API（聚合 `devices` + `device_batteries` + 绑定关系 + 当前遥测值）
  - [x] 导出 API（或前端导出：若数据量大建议后端导出）
- **交付物**：`/bms/battery/list` 页面（或同等入口）、对应 API、Excel 导出。
- **验收用例**：
  - [x] 厂家：能按经销商筛选并导出
  - [x] 经销商：看不到非名下设备
  - [x] 关键字段有值/空值处理正确

### 迭代 2：Web「电池导入与分配」一期（1 周）——对齐 2.1.2.1（批量导入/分配）
- **范围**：
  - [x] Excel 模板下载（含必填字段：序列号、型号、出厂日期、额定电压、质保期）
  - [x] 导入：解析、校验（重复序列号/型号不存在/日期格式）
  - [x] 导入后批量分配给经销商（厂家权限）
  - [x] 导入结果：成功/失败行回显，可导出失败明细
- **需要补齐/新增后端能力（必需）**：
  - [x] 导入 API（上传文件/或提交解析后的 JSON）
  - [x] 批量分配 API（更新 `device_batteries.dealer_id` 与流转状态）
- **交付物**：导入入口、导入校验、批量分配。
- **验收用例**：
  - [x] 1000 行导入可完成（性能基线）
  - [x] 重复序列号/未知型号会被拦截并返回明细

### 迭代 3：Web「经销商数据穿透 + 终端用户管理 + 授权管理」一期（1 周）——对齐 2.1.4.x
- **范围**：
  - [x] 经销商详情：名下设备、终端用户、维保统计（聚合数字 + 列表入口）
  - [x] 终端用户列表：手机号/经销商/绑定设备数筛选（基于绑定关系聚合）
  - [x] 查看绑定设备；强制解绑（厂家/经销商权限）
  - [x] 授权管理：先落地“基础版/高级版”权限模板（菜单级），支持对经销商账号生效（Casbin 角色模板）
- **依赖**：账号体系与 RBAC/Casbin、以及用户与 dealer_id 的关联策略。
- **交付物**：终端用户页、授权配置页（最小可用）。
- **验收用例**：
  - [x] 经销商账号登录后菜单权限符合模板（通过 `ROLE_DEALER_BASIC/ROLE_DEALER_ADVANCED` 控制 `sys_ui_elements` 菜单树）
  - [ ] 强制解绑后，设备回到未激活/合理流转状态

### 迭代 4：Web「Dashboard + 告警概览 + 趋势」一期（1 周）——对齐 2.1.1
- **范围**：
  - [x] 指标卡：厂家/经销商差异化统计（设备总数/在线/激活/活跃告警）
  - [x] 告警概览：近7日、级别分布、Top3 类型（基于 latest_device_alarms）
  - [x] 趋势：在线趋势（厂家 24h 曲线；经销商暂展示实时点，后续补齐按经销商采样）
  - [x] 快捷入口：电池列表、经销商管理、维保中心、转移记录（穿透版）
- **地图（建议分阶段）**：
  - 第一期：先做“区域筛选 + 统计/列表穿透”
  - 第二期：若 `devices.location` 数据质量达标再接地图聚合点
- **交付物**：`/bms/dashboard`（或首页挂载）
- **验收用例**：厂家与经销商看见不同口径数据，穿透跳转正确。

### 迭代 5：Web「激活日志 + 退换货 + 操作记录」一期（1 周）——对齐 2.1.3.3/2.1.3.4/2.1.5.1
- **范围**：
  - [x] 激活日志：按设备/用户/时间/方式查询（当前基于 APP 绑定操作日志派生）
  - [x] 退换货：复用维保 `type=RETURN/EXCHANGE`（维保中心已支持按类型筛选与状态流转）
  - [x] 操作记录：对接 `operation_logs`，按人/模块/类型/时间筛选（已补齐派生字段）
- **需要补齐/新增后端能力（可能项）**：退换货与维保类型/状态流转规范化。
- **交付物**：三张运营/审计页面 + 对应接口。
- **验收用例**：对任一设备可查到激活链路与售后流转记录。

### 迭代 5.1：Web「电池维保记录（手工录入）」一期（2–3 天）——对齐 2.1.3.2
- **范围**：
  - [x] 电池维保记录：新增（设备序列号/故障类型/维修时间/维修人员/解决方案/配件清单/是否影响质保）
  - [x] 电池维保记录：列表筛选（设备序列号/故障类型/时间范围）与详情查看
- **实现说明**：独立表 `battery_maintenance_records`，在 Web「维保中心」以 Tab 形式呈现，复用 BMS 数据权限中间件做经销商范围控制。

### 迭代 6：OTA 管理（1–2 周）——对齐 2.1.2.1（OTA 列表/批量推送）
- **范围**：
  - [ ] OTA 包管理（版本、更新日志、适配设备配置）
  - [ ] OTA 任务管理（选择设备/按筛选批量、下发、进度与结果）
  - [ ] 支持失败重试/取消（如后端支持）
- **依赖**：现有 OTA 相关表与路由（仓库已存在 `ota` 路由），需要与 BMS 设备口径对齐。
- **交付物**：`/bms/ota/*` 页面与端到端推送能力。
- **验收用例**：至少支持 100 台设备批量推送与进度可见。

---

## 5. APP 端并行计划（建议与 Web 并行）

### APP-1：登录/注册/找回（1 周）——对齐 2.2.1
- [ ] 手机号+密码登录
- [ ] 注册（短信验证码若暂无网关则先走测试验证码/灰度）
- [ ] 找回密码
- **交付物**：可登录进入主页面。

### APP-2：设备列表 + 扫码绑定/解绑（1 周）——对齐 2.2.2
- [ ] 卡片式设备列表（SOC/在线态/绑定时间排序）
- [ ] 扫码绑定（对接 `/api/v1/app/device/bind`）
- [ ] 解绑/重命名（解绑对接 `/api/v1/app/device/unbind`）
- **交付物**：终端用户可完成“扫码激活→看到设备”。

### APP-3：控制面板 + 告警 + 维保提交（2 周）——对齐 2.2.3/2.2.4
- [ ] 仪表盘（电压/电流/功率/SOC/SOH/质保）
- [ ] 电芯页（矩阵/异常高亮）
- [ ] 告警列表与处理
- [ ] 维保申请提交（对接 `/api/v1/warranty`）

### APP-4：OTA + 参数设置 + BLE 双模（2–3 周）——对齐 2.2.3.3/2.2.5
- [ ] OTA：版本信息/下载/升级流程/离线升级策略
- [ ] 参数设置：高级入口（含密码策略）
- [ ] BLE 通信封装与“蓝牙优先、MQTT 降级”策略

---

## 6. 关键依赖与风险清单（必须前置跟踪）
- **数据口径风险**：SOC/SOH/在线/告警来源需统一（遥测 current 表 vs 业务表字段）。
- **地图风险**：`devices.location` 数据质量与聚合策略决定地图能否按期交付。
- **权限风险**：经销商权限与 Casbin/菜单/按钮绑定策略若不明确，会反复返工。
- **APP 风险**：BLE 兼容性与协议解析属于高风险项，需尽早拿到设备协议/样机。
- **OTA 风险**：现有 OTA 模块与 BMS 设备关系、任务状态机需对齐，否则只能做“页面壳”。

---

## 7. 每周例行交付与汇报模板（建议）
- **本周完成**：功能清单（对应 2.1.x/2.2.x）
- **联调结果**：接口回归通过率、阻塞问题
- **下周计划**：迭代目标与验收点
- **风险/依赖**：需要业务/硬件/运维支持的事项

---

## 附录 A：已完成模块的核心接口（便于回归）
- **经销商**：`/api/v1/dealer`（增删改查）
- **电池型号**：`/api/v1/battery/model`（增删改查）
- **设备转移**：`/api/v1/device/transfer`、`/api/v1/device/transfer/history`
- **APP 绑定**：`/api/v1/app/device/bind`、`/api/v1/app/device/unbind`、`/api/v1/app/device/list`
- **维保**：`/api/v1/warranty`（创建/列表）、`/api/v1/warranty/{id}`（详情/更新）
