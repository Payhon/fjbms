# 云平台参数修改与OTA协议
## 一、基础说明
- 数据格式：默认大端模式
- 通信接口：UART、485
- 默认波特率：9600，8N1
- 上位机地址：0XFE
- 目标地址：单机默认为0x01
- 校验算法：MODBUS CRC校验，校验数据包含来源地址、目标地址、指令ID、DATA数量和所有DATA
- 备注：H表示高字节，L表示低字节；保留或不支持某地址功能，用FF填充

## 二、核心功能指令
### 2.1 同步BMS时间
| 地址范围 | 名称 | 数据类型 | 说明 |
| --- | --- | --- | --- |
| 0X57C~0X57D | BMS板时间 | 时间戳 | 发送4个字节时间戳同步 |

### 2.2 获取BMS板UUID
| 功能码 | 起始地址 | 寄存器数量 | 返回数据 |
| --- | --- | --- | --- |
| 0XFF | 0x0000 | 0x0008 | 16字节UUID |

### 2.3 仪表地址配置（0XFC）
#### 功能说明
小程序已连接某个电池/仪表后，需连接新电池时，发送6个新MAC地址，用于仪表变更连接至新MAC地址。

#### 指令示例
- 发送指令：7F 55 FE FC 10 00 00 00 03 06 BC EC 3A 4A AB AC CRCL RCH FD
- 回复指令：7F 55 FC FE 10 00 00 00 03 CRCL CRCH ED

## 三、参数配置表
### 3.1 电压配置
| 地址 | 配置项 | 字节描述 | 字节长度 | 读/写 | 单位 | 偏移量 | 分辨率 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0x400 | 单体过压告警电压 | / | 2 | RW | V | 0 | 0.001 | 参考值3550mV |
| 0x401 | 单体过充保护电压 | / | 2 | RW | V | 0 | 0.001 | 参考值3650mV |
| 0x402 | 单体过充告警延时 | L | 1 | RW | S | 0 | 0.1 | 参考值10，即1s |
| 0x402 | 单体过充保护延时 | H | 1 | RW | S | 0 | 0.1 | 参考值10，即1s |
| 0x402 | 回馈过充保护延时 | L | 1 | RW | S | 0 | 0.1 | 参考值50，即5s |
| 0x403 | 常温低温阀值温度 | H | 1 | RW | ℃ | -40 | 1 | 参考值0度，即40（偏移-40） |
| 0x404 | 单体过压保护解除电压 | / | 2 | RW | V | 0 | 0.001 | 参考值3500mV |
| 0x405 | 单体过充告警解除电压差 | / | 2 | RW | V | 0 | 0.001 | 参考值3450mV |
| 0x406 | 容量解除 | L | 2 | RW | / | / | 1 | 单位1%SOC，参考值96，即SOC<96% |
| 0x407 | 过压放电解除电流 | L | 1 | RW | A | 1 | 0.1 | 参考值10，即放电电流≥1A |
| 0x407 | 欠压充电解除电流 | H | 1 | RW | A | 1 | 0.1 | 参考值10，即充电电流≥1A |
| 0x408 | 单体过压告警解除延时 | L | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0x408 | 单体过压保护解除延时 | H | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0x409 | 常温单体过放告警电压 | / | 2 | RW | V | 1 | 0.001 | 参考值2800mV |
| 0x40A | 常温单体过放保护电压 | / | 2 | RW | V | 1 | 0.001 | 参考值2800mV |
| 0x40B | 低温单体过放告警电压 | / | 2 | RW | V | 1 | 0.001 | 参考值2800mV |
| 0x40C | 低温单体过放保护电压 | / | 2 | RW | V | 1 | 0.001 | 参考值2500mV |
| 0x40D | 单体过放告警延时 | L | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0x40E | 单体过放保护延时 | H | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0x40F | 单体过放保护解除电压 | / | 2 | RW | V | 1 | 0.001 | 参考值2850mV |
| 0x40F | 单体过放告警解除电压 | / | 2 | RW | V | 1 | 0.001 | 参考值2900mV |
| 0X410 | 单体过放告警解除延时 | L | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X410 | 单体过放保护解除延时 | H | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X411 | 总压过压告警电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X412 | 总压过压保护电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X413 | 总压过压保护延时 | L | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X413 | 总压过压告警延时 | H | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X414 | 总压过压告警解除电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X415 | 总压过压保护解除电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X416 | 总压过压解除延时 | L | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X416 | 总压过压告警解除延时 | H | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X417 | 常温总压过放告警电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X418 | 常温总压过放保护电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X419 | 低温总压过放告警电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X41A | 低温总压过放保护电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X41B | 总压过放告警延时 | L | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X41B | 总压过放保护延时 | H | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X41C | 总压过放告警解除电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X41D | 总压过放保护解除电压 | / | 2 | RW | V | 1 | 0.01 | 单位0.01v |
| 0X41E | 总压过放告警解除延时 | L | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |
| 0X41E | 总压过放保护解除延时 | H | 1 | RW | S | 1 | 0.1 | 参考值10，即1s |

### 3.2 电流配置
| 地址 | 配置项 | 字节描述 | 字节长度 | 读/写 | 单位 | 偏移量 | 分辨率 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0X420 | 充电过流保护小电流 | / | 2 | RW | A | 1 | 0.1 | 较小充电电流保护阀值，延时时间较长 |
| 0X421 | 充电过流保护大电流 | / | 2 | RW | A | 1 | 0.1 | 较大充电电流保护阀值，延时时间较短 |
| 0x422 | 充电过流告警延时 | L | 1 | RW | S | 1 | 1 | - |
| 0x422 | 充电过流保护大电流延时 | H | 1 | RW | S | 1 | 1 | - |
| 0x423 | 充电过流保护小电流延时 | L | 1 | RW | S | 1 | 1 | - |
| 0x423 | 保留 | H | 1 | RW | / | / | / | - |
| 0x424 | 充电过流告警解除延时 | L | 1 | RW | S | 1 | 1 | 充电过流告警解除延时 |
| 0x424 | 自动解除时间 | H | 1 | RW | MIN | 1 | 1 | 单位分钟，参考值1，即1min后自动解除 |
| 0x425 | 充电过流告警解电流 | / | 2 | RW | A | 1 | 0.1 | 单位0.1A |
| 0x426 | 放电解除电流 | L | 1 | RW | A | 1 | 0.1 | 单位0.1A |
| 0x426 | 自动解除锁定次数 | H | 1 | RW | / | 1 | 1 | - |
| 0x427 | 放电过流告警电流 | / | 2 | RW | A | 1 | 0.1 | - |
| 0x428 | 放电过流小电流保护电流 | / | 2 | RW | A | 1 | 0.1 | - |
| 0x429 | 放电过流大电流保护电流 | / | 2 | RW | A | 1 | 0.1 | - |
| 0x429 | 放电过流告警延时 | L | 1 | RW | S | 1 | 1 | - |
| 0x42A | 放电过流大电流保护延时 | H | 1 | RW | S | 1 | 1 | - |
| 0x42B | 放电过流小电流保护延时 | L | 1 | RW | S | 1 | 1 | - |
| 0x42B | 自动解除时间 | H | 1 | RW | MIN | 1 | 1 | 单位分钟，参考值1，即1min后自动解除 |
| 0X42C | 放电过流告警解除电流 | / | 2 | RW | A | 1 | 0.1 | - |
| 0X42D | 充电解除电流 | L | 1 | RW | A | 1 | 0.1 | 充电解除电流 |
| 0X42D | 锁定次数 | H | 1 | RW | / | 1 | / | 自动解除锁定次数 |

### 3.3 温度配置
| 地址 | 配置项 | 字节描述 | 字节长度 | 读/写 | 单位 | 偏移量 | 分辨率 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0x438 | MOS过温告警温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x438 | MOS过温保护温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x439 | MOS过温告警解温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x439 | MOS保护解除温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x43A | MOS过温告警延时 | L | 1 | RW | S | 0 | / | - |
| 0x43A | MOS过温保护延时 | H | 1 | RW | S | 0 | / | - |
| 0x43B | MOS过温告警解除延时 | L | 1 | RW | S | 0 | / | - |
| 0x43B | MOS过温保护解除延时 | H | 1 | RW | S | 0 | / | - |
| 0x43C | 环境过温告警温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x43C | 环境过温保护温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x43D | 环境过温告警解温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x43D | 环境过保护解除温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x43E | 环境低温告警温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x43E | 环境低温保护温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x43F | 环境低温告警解温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x43F | 环境低温保护解除温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x440 | 环境过温告警延时 | L | 1 | RW | S | 0 | / | - |
| 0x440 | 环境过温保护延时 | H | 1 | RW | S | 0 | / | - |
| 0x441 | 环境过温告警解除延时 | L | 1 | RW | S | 0 | / | - |
| 0x441 | 环境过温保护解除延时 | H | 1 | RW | S | 0 | / | - |
| 0x442 | 充电低温告警温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x442 | 充电低温保护温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x443 | 充电低温警告解除温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x443 | 充电低温保护解除温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x444 | 充电高温告警温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x444 | 充电高温保护温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x445 | 充电高温告警解除温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x445 | 充电高温保护解除温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x446 | 充电高温告警延时 | L | 1 | RW | S | 0 | / | - |
| 0x446 | 充电高温保护延时 | H | 1 | RW | S | 0 | / | - |
| 0x447 | 充电高温告警解除延时 | L | 1 | RW | S | 0 | / | - |
| 0x447 | 充电高温保护解除延时 | H | 1 | RW | S | 0 | / | - |
| 0x448 | 放电低温告警温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x448 | 放电低温保护温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x449 | 放电低温告警解除温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x449 | 放电低温保护解除温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x44A | 放电高温告警温度 | L | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x44A | 放电高温保护温度 | H | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x44B | 放电高温警告解除温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x44C | 放电高温保护解除温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x44D | 放电高温告警延时 | / | 1 | RW | S | 1 | / | - |
| 0x44E | 放电高温保护延时 | / | 1 | RW | S | 1 | / | - |
| 0x44F | 放电高温告警解除延时 | / | 1 | RW | S | 1 | / | - |
| 0x450 | 放电高温保护解除延时 | / | 1 | RW | S | 1 | / | - |
| 0x451 | 电芯高温告警温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x451 | 热失控电芯温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x452 | 电芯高温告警解除温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x452 | 高温告警延时 | / | 1 | RW | S | 1 | / | - |
| 0x453 | 高温告警解除延时 | / | 1 | RW | S | 1 | / | - |
| 0x453 | 加热电芯开启温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x454 | 加热电芯关闭温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x454 | 加热膜温度保护温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x455 | 加热膜温度保护恢复温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x455 | 加热开启延时 | / | 1 | RW | S | 1 | / | - |
| 0x456 | 加热关闭延时 | / | 1 | RW | S | 1 | / | - |
| 0x456 | 极柱温度保护温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x457 | 极柱温度保护恢复温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |

### 3.4 其他配置
| 地址 | 配置项 | 字节描述 | 字节长度 | 读/写 | 单位 | 偏移量 | 分辨率 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0x458 | 均衡开启电压 | / | 2 | RW | V | 0 | 0.001 | 参考值3500mV |
| 0x459 | 开启压差 | / | 1 | RW | V | 0 | 0.001 | 参考值30mV |
| 0x45A | 停止压差 | / | 1 | RW | V | 0 | 0.001 | 参考值10mV |
| 0x45A | 均衡功能高温禁止温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x45B | 均衡功能低温禁止温度 | / | 1 | RW | ℃ | -40 | 1 | 单位1℃，偏移量-40 |
| 0x45B | 压差报警压差 | / | 1 | RW | V | 0 | 0.01 | 单位10mV |
| 0x45C | 压差报警恢复压差 | / | 1 | RW | V | 0 | 0.01 | 单位10mV |
| 0x45C | 压差保护压差 | / | 1 | RW | V | 0 | 0.01 | 单位10mV |
| 0x45D | 压差保护恢复压差 | / | 1 | RW | V | 0 | 0.01 | 单位10mV |
| 0x45D | 压差保护延时 | / | 1 | RW | S | 1 | / | 单位S |
| 0x45E | 压差解除延时 | / | 1 | RW | S | 1 | / | 单位S |
| 0x45E | 温差报警阈值 | / | 1 | RW | ℃ | 0 | 1 | - |
| 0x45F | 温差报警恢复阈值 | / | 1 | RW | ℃ | 0 | 1 | - |
| 0x45F | 温差保护阈值 | / | 1 | RW | ℃ | 0 | 1 | - |
| 0x460 | 温差保护恢复阈值 | / | 1 | RW | ℃ | 0 | 1 | - |
| 0x460 | 温差保护延时 | / | 1 | RW | S | 1 | / | - |
| 0x460 | 温差解除延时 | H | 1 | RW | S | 0 | 1 | - |
| 0x45D | 电量低告警门槛 | L | 1 | RW | 1% | 0 | 1 | 参考值5，即SOC<5% |
| 0x45D | 保留 | H | 1 | RW | / | / | / | - |
| 0x45E | 满电判断-总压阈值 | / | 2 | RW | V | 0 | 0.1 | 单位0.1V |
| 0X45F | 满电判断-电流阈值 | / | 2 | RW | A | 0 | 0.1 | 单位0.1A |
| 0X45F | 满电判断-持续时间 | L | 1 | RW | S | 0 | 1 | 单位S |
| 0x460 | 保留 | H | 1 | RW | / | / | / | - |

### 3.5 编号配置
| 地址范围 | 配置项 | 字节长度 | 读/写 | 说明 |
| --- | --- | --- | --- | --- |
| 0X500~0X50F | 电池组编号 | 32 | RW | ASCII字符串，不足32字节带结束符\0 |
| 0X53A~0X56F | DTU域名和端口地址 | 108 | RW | ASCII字符串，不足32字节带结束符\0 |

## 四、系统寄存器（上位机最高权限配置）
| 地址 | 名称 | 字节描述 | 字节长度 | 读/写 | 单位 | 偏移量 | 分辨率 | 描述 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 1 | 高低串数配置 | H：高串数（一般为零）；L：低串数 | 2 | RW | / | / | / | 高串+低串等于串数总和，支持改串数功能 |
| 48~49 | 设计容量 | / | 2*2 | RW | / | / | 0.001AH | 支持改容量 |
| 50~51 | 满充容量 | / | 2*2 | RW | / | / | 0.001AH | 支持改容量 |
| 52~53 | 剩余容量 | / | 2*2 | RW | / | / | 0.001AH | 支持改容量 |
| 62 | 功能配置 | / | 2 | RW | / | / | / | bit14-保温加热功能；bit13-放电加热功能；bit12-低温加热功能；bit10-充电允许（0允许，1禁止）；bit9-放电允许（0允许，1禁止） |

## 五、工厂指令操作
### 5.1 功能键操作寄存器（0X57A~0X57B）
| 位标识 | 功能描述 | 操作说明 |
| --- | --- | --- |
| BIT30 | 放电控制 | 1：禁止放电；0：允许放电 |
| BIT28 | 功能4控制 | 1：功能1打开；0：无操作；2：功能1关闭 |
| BIT26 | 功能3控制 | 1：功能1打开；0：无操作；2：功能1关闭 |
| BIT22 | 功能1控制 | 1：功能1打开；0：无操作；2：功能1关闭 |
| Bit20 | 保留 | - |
| BIT19 | 保护状态清除 | 1：清除；0：无操作 |
| BIT18 | 循环次数擦除 | 1：擦除；0：无操作 |
| BIT17 | 历史记录擦除 | 1：擦除；0：无操作 |
| BIT16 | 参数恢复默认 | 1：擦除当前参数并调用默认参数；0：无操作 |
| BIT2 | 一键休眠 | 1：进入休眠；0：无操作 |
| BIT1 | 保留 | - |
| BIT0 | 一键掉电 | 1：掉电；0：无操作 |

### 5.2 工厂指令示例
```
1. 进入生产测试模式（测试前进入，BMS板退出客户逻辑，充放电MOS无故障常开）
7F 55 FE 00 10 05 7A 00 02 04 00 00 04 00 4D 98 FD

2. 退出生产测试模式（恢复客户逻辑，如防打火等）
7F 55 FE 00 10 05 7A 00 02 04 00 00 08 00 48 98 FD

3. 均衡全开
7F 55 FE 00 10 05 7A 00 02 04 00 00 10 00 42 98 FD

4. 均衡全关
7F 55 FE 00 10 05 7A 00 02 04 00 00 20 00 56 98 FD

5. 一键休眠（发指令后10S内不能再下发指令）
7F 55 FE 00 10 05 7A 00 02 04 00 00 00 04 4E 9B FD

6. 一键掉电
7F 55 FE 00 10 05 7A 00 02 04 00 00 00 01 8E 98 FD
```

## 六、BOOT升级协议
| 操作步骤 | 主机指令 | 字节长度 | BMS回复 | 回复长度 | 说明 |
| --- | --- | --- | --- | --- | --- |
| 主机查询版本 | 0x55 0XFE 0x0X（00表示所有从机） | 4 | 0X55 0x0X 0XFE 0x50 32BYTE硬件标识码 1BYTE软件版本 0xFD | 37 | 软件版本：0xFF表示在BOOT中，其它表示在APP中 |
| 主机进入bootloader | 0x55 0XFE 0x0X 0x51 | 4 | 0x55 0x0X 0XFE 0x51 0xFD | 4 | 禁止进入BOOT场景：1.充放电中；2.SOC过低；3.其它禁止 |
| 改波特率（上一条指令后延迟200MS） | 0x55 0XFE 0x0X 0x52 4BYTE固件总大小 | 8 | 0x55 0x0X 0XFE 0x52 BYTE1（0成功/1失败） BYTE2（请求每包大小） 0xFD | 6 | 1. 新波特率：UART为9600，CAN为250K；2. 每包大小选项：0=64BYTES、1=128BYTES、2=256BYTES、3=512BYTES、4=1024BYTES；3. 升级失败时，上位机恢复原波特率重新开始 |
| 发送固件数据 | 0x55 0XFE 0x0X 0x53 2BYTE固件包序号（0~N） xBYTE固件数据 0XFD | 2+X+1 | 0x55 0x0X 0XFE 0x53 BYTE1（0成功/1未初始化/2写错误/3包序不对） BYTE2~BYTE3（请求包序） 0xFD | 6 | - |
| 升级完成，跳转BOOT | 0x55 0XFE 0x0X 0x54 4BYTE固件数据CRC32的值 0xFD | 9 | 0x55 0x0X 0XFE 0X54 BYTE1（0成功并跳转APP/1校验失败） 0XFD | 6 | 双系统BMS刷FLASH回应较迟，主机最长等待4S |